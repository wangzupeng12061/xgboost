# 可视化模块实现说明

## 概述

可视化模块已完整实现，提供7种专业的量化策略分析图表，全面展示策略的收益、风险和因子特征。所有图表自动生成并保存为高分辨率PNG文件。

## 实现状态

✅ **已完成** - 可视化模块完全可用，已集成到主程序

## 生成的图表清单

### 1. 净值曲线图 (equity_curve)
**文件**: `equity_curve_{timestamp}.png`  
**尺寸**: ~350KB, 14x6英寸  
**内容**:
- 策略组合净值曲线（红色）
- 基准指数净值曲线（蓝色，沪深300）
- 归一化显示（起始值=100）
- 清晰展示策略表现vs基准

**用途**: 直观对比策略与基准的表现差异

---

### 2. 回撤曲线图 (drawdown)
**文件**: `drawdown_{timestamp}.png`  
**尺寸**: ~437KB, 14x6英寸  
**内容**:
- 策略回撤曲线（红色填充区域）
- 基准回撤曲线（蓝色填充区域）
- 0轴参考线
- 显示最大回撤深度和持续时间

**用途**: 评估策略的风险控制能力和最大损失

---

### 3. 收益率分布图 (returns_dist)
**文件**: `returns_dist_{timestamp}.png`  
**尺寸**: ~96KB, 14x5英寸  
**内容**:
- **左图**: 日收益率直方图（策略vs基准）
- **右图**: 收益率箱线图，显示中位数、四分位数、异常值

**用途**: 分析收益率的分布特征和波动范围

---

### 4. 滚动指标图 (rolling_metrics)
**文件**: `rolling_metrics_{timestamp}.png`  
**尺寸**: ~367KB, 14x10英寸  
**内容**:
- **子图1**: 60日滚动收益率
- **子图2**: 60日滚动波动率（年化）
- **子图3**: 60日滚动夏普比率

**用途**: 观察策略在不同时间段的稳定性和表现变化

---

### 5. 月度收益热力图 (monthly_returns)
**文件**: `monthly_returns_{timestamp}.png`  
**尺寸**: ~76KB, 14x8英寸  
**内容**:
- 年份 x 月份的热力图矩阵
- 颜色编码：绿色=正收益，红色=负收益
- 每个单元格显示具体收益率数值

**用途**: 识别季节性规律和月度表现模式

---

### 6. 因子重要性图 (feature_importance)
**文件**: `feature_importance_{timestamp}.png`  
**尺寸**: ~131KB, 12x8英寸  
**内容**:
- Top 20 因子的重要性得分
- 水平条形图，颜色梯度表示重要性
- 按重要性降序排列

**用途**: 识别对预测贡献最大的因子，指导因子优化

---

### 7. 综合看板 (dashboard)
**文件**: `dashboard_{timestamp}.png`  
**尺寸**: ~435KB, 16x12英寸  
**内容**:
- **位置1**: 净值曲线（策略vs基准）
- **位置2**: 回撤曲线
- **位置3**: 日收益率分布直方图
- **位置4**: 月度收益柱状图
- **位置5**: 关键绩效指标文本框
  - 累计收益率
  - 年化收益率
  - 夏普比率
  - 最大回撤
  - 胜率

**用途**: 一页汇总所有关键信息，适合报告和演示

---

## 技术特性

### 1. 自动化生成
- ✅ 集成到主程序流程（Step 10）
- ✅ 无需手动操作
- ✅ 每次运行自动生成时间戳文件

### 2. 高质量输出
- **分辨率**: 300 DPI
- **格式**: PNG（无损压缩）
- **尺寸**: 适合打印和演示
- **中文支持**: 完美显示中文标签

### 3. 性能优化
- **非交互式后端**: matplotlib.use('Agg')
- **不显示窗口**: 纯后台生成
- **快速执行**: 7个图表仅需2-3秒

### 4. 配置灵活
```yaml
# config/config.yaml
output:
  figure_path: "results/figures/"  # 图表保存路径
  generate_plots: true              # 是否生成图表
```

---

## 使用方法

### 自动生成（推荐）
```bash
# 运行主程序，自动生成所有图表
python main.py
```

### 手动调用
```python
from src.utils.visualization import (
    plot_equity_curve,
    plot_drawdown,
    plot_returns_distribution,
    plot_rolling_metrics,
    plot_monthly_returns,
    plot_feature_importance,
    create_dashboard
)

# 准备数据
portfolio_values = pd.Series([...], index=dates)
benchmark_values = pd.Series([...], index=dates)

# 生成单个图表
plot_equity_curve(
    portfolio_values=portfolio_values,
    benchmark_values=benchmark_values,
    save_path='results/figures/my_equity_curve.png'
)

# 生成综合看板
create_dashboard(
    portfolio_values=portfolio_values,
    benchmark_values=benchmark_values,
    metrics=metrics_dict,
    save_path='results/figures/my_dashboard.png'
)
```

---

## 实际运行效果

### 生成日志示例
```
2025-11-03 22:16:26 - INFO - 开始: 生成图表
2025-11-03 22:16:26 - INFO -   生成净值曲线...
图表已保存: results/figures/equity_curve_20251103_221626.png
2025-11-03 22:16:26 - INFO -   生成回撤曲线...
2025-11-03 22:16:26 - INFO -   生成收益率分布...
2025-11-03 22:16:27 - INFO -   生成滚动指标...
2025-11-03 22:16:27 - INFO -   生成月度收益...
2025-11-03 22:16:28 - INFO -   生成因子重要性...
2025-11-03 22:16:28 - INFO -   生成综合看板...
2025-11-03 22:16:28 - INFO - ✓ 图表生成完成，保存至: results/figures/
2025-11-03 22:16:28 - INFO - 完成: 生成图表 (耗时: 2.39秒)
```

### 文件输出
```bash
results/figures/
├── equity_curve_20251103_221626.png       # 353KB
├── drawdown_20251103_221626.png           # 437KB
├── returns_dist_20251103_221626.png       #  96KB
├── rolling_metrics_20251103_221626.png    # 367KB
├── monthly_returns_20251103_221626.png    #  76KB
├── feature_importance_20251103_221626.png # 131KB
└── dashboard_20251103_221626.png          # 435KB
```

---

## 图表解读指南

### 净值曲线图解读
- **向上趋势**: 策略盈利
- **斜率**: 收益率快慢
- **与基准对比**: 
  - 红线>蓝线 → 跑赢基准
  - 红线<蓝线 → 跑输基准

### 回撤曲线图解读
- **深度**: 回撤幅度（%）
- **宽度**: 回撤持续时间
- **恢复速度**: 从谷底回升的快慢
- **频率**: 回撤发生的次数

### 收益率分布解读
- **正态分布**: 理想的分布形态
- **右偏**: 大额盈利偏多（好）
- **左偏**: 大额亏损偏多（不好）
- **厚尾**: 极端事件多（高风险）

### 滚动指标解读
- **收益率平稳**: 策略稳定
- **波动率上升**: 风险增加
- **夏普比率下降**: 风险调整后收益变差

### 月度收益解读
- **连续绿色**: 持续盈利期
- **连续红色**: 持续亏损期
- **颜色交替**: 波动较大

### 因子重要性解读
- **Top因子**: 核心预测能力
- **重要性分布**: 
  - 集中 → 依赖少数因子
  - 分散 → 多因子共同作用

---

## 实际案例分析（基于当前策略）

### 净值曲线
- 策略净值从100降至91.86
- 基准净值相对稳定
- 策略明显跑输基准

### 回撤分析
- 最大回撤: -16.42%
- 持续时间: 125天
- 恢复缓慢，风险控制需加强

### 收益率分布
- 胜率: 42.03%（<50%，不够理想）
- 盈亏比: 1.18（>1，单次盈利>单次亏损）
- 分布偏左，小额亏损频繁

### 因子重要性
- Top因子: new_low_20d（20日新低）
- 动量类因子权重较高
- 需要增加价值和质量因子

---

## 优化建议

### 当前问题
1. ❌ 策略负收益（-8.14%）
2. ⚠️ 较大回撤（-16.42%）
3. ⚠️ 胜率偏低（42%）
4. ⚠️ 跑输基准（-22.26%）

### 改进方向
1. **因子优化**
   - 增加防守型因子
   - 优化因子权重
   - 测试不同因子组合

2. **风险控制**
   - 设置止损机制
   - 降低单票权重
   - 增加行业分散

3. **模型调优**
   - 超参数优化
   - 尝试不同标签方法
   - 增加样本权重

4. **选股策略**
   - 调整持仓数量
   - 优化调仓频率
   - 增加筛选条件

---

## 扩展功能（未来）

### 待实现的图表
1. **IC时序图**: 因子IC随时间变化
2. **分组回测**: 不同市场环境下的表现
3. **归因分析**: 收益来源分解
4. **交易分析**: 换手率、成交金额
5. **风险分析**: VaR、CVaR随时间变化

### 交互式图表
- 使用Plotly创建交互式HTML图表
- 支持缩放、悬停、筛选
- 生成在线看板

### 自动报告
- 自动生成PDF报告
- 包含图表和文字分析
- 一键分享

---

## 文件组织

```
results/
├── figures/                           # 图表目录
│   ├── equity_curve_YYYYMMDD_HHMMSS.png
│   ├── drawdown_YYYYMMDD_HHMMSS.png
│   ├── returns_dist_YYYYMMDD_HHMMSS.png
│   ├── rolling_metrics_YYYYMMDD_HHMMSS.png
│   ├── monthly_returns_YYYYMMDD_HHMMSS.png
│   ├── feature_importance_YYYYMMDD_HHMMSS.png
│   └── dashboard_YYYYMMDD_HHMMSS.png
├── reports/                           # 报告目录
│   ├── performance_metrics_YYYYMMDD_HHMMSS.csv
│   └── performance_report_YYYYMMDD_HHMMSS.txt
└── models/                            # 模型目录
    └── model_YYYYMMDD_HHMMSS.pkl
```

---

## 技术细节

### 颜色方案
- **策略**: #E74C3C (红色)
- **基准**: #3498DB (蓝色)
- **正值**: 绿色系
- **负值**: 红色系

### 字体设置
```python
plt.rcParams['font.sans-serif'] = [
    'SimHei',           # 黑体（Windows/Mac）
    'Arial Unicode MS', # Mac系统
    'DejaVu Sans'      # Linux系统
]
```

### 图表质量
- **DPI**: 300（印刷级别）
- **格式**: PNG（支持透明背景）
- **大小**: bbox_inches='tight'（自动裁剪边距）

---

## 故障排除

### 问题1: 图表显示乱码
**原因**: 系统没有中文字体  
**解决**: 安装字体或修改配置使用英文标签

### 问题2: 图表生成缓慢
**原因**: 使用交互式后端  
**解决**: 已设置`matplotlib.use('Agg')`，纯后台生成

### 问题3: 内存占用过高
**原因**: 图表未关闭  
**解决**: 已在保存后调用`plt.close()`释放内存

### 问题4: 找不到图表文件
**原因**: 路径配置错误  
**解决**: 检查`config.yaml`中的`figure_path`设置

---

## 总结

✅ **完整实现**: 7种专业图表全部可用  
✅ **自动化**: 集成到主程序，无需手动操作  
✅ **高质量**: 300 DPI，适合报告和演示  
✅ **高性能**: 2-3秒生成全部图表  
✅ **可扩展**: 易于添加新图表类型  

可视化模块为策略分析提供了全面的视觉支持，帮助快速识别问题和优化方向！📊📈
