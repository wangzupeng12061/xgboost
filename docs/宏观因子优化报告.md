# XGBoostå¤šå› å­é€‰è‚¡ç³»ç»Ÿ - å®è§‚å› å­ä¼˜åŒ–æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-03  
**ç‰ˆæœ¬**: v2.1  
**ä¼˜åŒ–ä¸»é¢˜**: å®è§‚ç»æµæ•æ„Ÿåº¦å› å­

---

## ä¸€ã€ä¼˜åŒ–æ¦‚è¿°

### 1.1 å®ç°ç›®æ ‡
åœ¨åŸæœ‰çš„ä»·æ ¼ã€ä¼°å€¼ã€æŠ€æœ¯ã€è¡Œä¸šå› å­åŸºç¡€ä¸Šï¼Œæ–°å¢**å®è§‚ç»æµæ•æ„Ÿåº¦å› å­**ï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿæ•æ‰ï¼š
- è‚¡ç¥¨å¯¹åˆ©ç‡å˜åŒ–çš„æ•æ„Ÿæ€§
- è‚¡ç¥¨å¯¹é€šèƒ€çš„æ•æ„Ÿæ€§
- è‚¡ç¥¨å¯¹ç»æµå‘¨æœŸçš„æ•æ„Ÿæ€§
- è‚¡ç¥¨å¯¹è´§å¸æ”¿ç­–çš„æ•æ„Ÿæ€§
- ç»¼åˆå®è§‚é£é™©è¯„ä¼°

### 1.2 å®ç°æˆæœ
âœ… **æ•°æ®æºæ‰©å±•**: æ–°å¢5ç±»å®è§‚ç»æµæ•°æ®ï¼ˆCPIã€M2ã€Shiborã€PMIã€GDPï¼‰  
âœ… **å› å­è®¡ç®—**: æ–°å¢7ä¸ªå®è§‚æ•æ„Ÿåº¦å› å­  
âœ… **ç³»ç»Ÿé›†æˆ**: å®Œå…¨é›†æˆåˆ°ä¸»æµç¨‹ï¼Œè‡ªåŠ¨æ£€æµ‹å’Œè®¡ç®—  
âœ… **æ€§èƒ½éªŒè¯**: å®è§‚å› å­å·²å‡ºç°åœ¨æœ€ç»ˆè¯„ä¼°åˆ—è¡¨ä¸­

---

## äºŒã€å®è§‚æ•°æ®æº

### 2.1 åŠ è½½çš„å®è§‚æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡åç§° | æ•°æ®é¢‘ç‡ | è¯´æ˜ |
|----------|----------|----------|------|
| **é€šèƒ€** | CPI_yoy | æœˆåº¦ | å±…æ°‘æ¶ˆè´¹ä»·æ ¼æŒ‡æ•°åŒæ¯” |
| | CPI_mom | æœˆåº¦ | å±…æ°‘æ¶ˆè´¹ä»·æ ¼æŒ‡æ•°ç¯æ¯” |
| | CPI_val | æœˆåº¦ | CPIç»å¯¹å€¼ |
| **è´§å¸ä¾›åº”** | M2 | æœˆåº¦ | è´§å¸ä¾›åº”é‡M2 |
| | M2_yoy | æœˆåº¦ | M2åŒæ¯”å¢é•¿ç‡ |
| **åˆ©ç‡** | Shibor_on | æ—¥åº¦ | ä¸Šæµ·é“¶è¡Œé—´åŒä¸šæ‹†æ”¾åˆ©ç‡(éš”å¤œ) |
| | Shibor_1w | æ—¥åº¦ | Shibor 1å‘¨ |
| | Shibor_1m | æ—¥åº¦ | Shibor 1æœˆ |
| **ç»æµæ´»åŠ¨** | PMI | æœˆåº¦ | åˆ¶é€ ä¸šé‡‡è´­ç»ç†æŒ‡æ•° |
| | PMI_mom | æœˆåº¦ | PMIç¯æ¯” |
| **ç»æµå¢é•¿** | GDP | å­£åº¦ | å›½å†…ç”Ÿäº§æ€»å€¼ |
| | GDP_yoy | å­£åº¦ | GDPåŒæ¯”å¢é•¿ç‡ |

### 2.2 æ•°æ®åŠ è½½å®ç°

**æ–°å¢æ–¹æ³•**: `DataLoader.load_macro_data()`

```python
def load_macro_data(self, start_date: str, end_date: str) -> pd.DataFrame:
    """
    åŠ è½½å®è§‚ç»æµæ•°æ®
    
    æ•°æ®æº: Tushare API
    - cn_cpi: CPIæ•°æ®
    - cn_pmi: PMIæ•°æ®  
    - cn_m: M2è´§å¸ä¾›åº”é‡
    - shibor: ä¸Šæµ·é“¶è¡Œé—´åŒä¸šæ‹†æ”¾åˆ©ç‡
    - cn_gdp: GDPæ•°æ®
    
    Returns:
        å®è§‚æ•°æ®DataFrameï¼Œæ—¥åº¦é¢‘ç‡ï¼ˆæœˆåº¦/å­£åº¦æ•°æ®å‰å‘å¡«å……ï¼‰
    """
```

**å…³é”®ç‰¹æ€§**:
1. **å¤šé¢‘ç‡å¯¹é½**: æœˆåº¦ã€å­£åº¦æ•°æ®é€šè¿‡å‰å‘å¡«å……è½¬æ¢ä¸ºæ—¥åº¦ï¼Œä¸è‚¡ç¥¨æ•°æ®å¯¹é½
2. **å®¹é”™å¤„ç†**: å„æŒ‡æ ‡åŠ è½½å¤±è´¥ä¸å½±å“å…¶ä»–æŒ‡æ ‡
3. **æ•°æ®å¹¿æ’­**: å®è§‚æ•°æ®æŒ‰æ—¥æœŸå¹¿æ’­åˆ°æ‰€æœ‰è‚¡ç¥¨

### 2.3 åŠ è½½æ•ˆæœ

```
âœ… æˆåŠŸåŠ è½½: 26,939æ¡è®°å½•ï¼ˆæ—¥åº¦ï¼‰
âœ… æ—¶é—´èŒƒå›´: 2024-01-01 è‡³ 2024-10-31
âœ… å¯ç”¨æŒ‡æ ‡: cpi_yoy, cpi_mom, cpi_val, m2, m2_yoy, 
             shibor_on, shibor_1w, shibor_1m
âš ï¸  PMIæ•°æ®: APIæ ¼å¼é—®é¢˜ï¼Œæš‚æœªæˆåŠŸ
âš ï¸  GDPæ•°æ®: å­£åº¦æ•°æ®æ ¼å¼é—®é¢˜ï¼Œæš‚æœªæˆåŠŸ
```

---

## ä¸‰ã€å®è§‚æ•æ„Ÿåº¦å› å­

### 3.1 å› å­åˆ—è¡¨

| å› å­åç§° | ç±»åˆ« | è®¡ç®—æ–¹æ³• | ç»æµå«ä¹‰ |
|----------|------|----------|----------|
| **interest_rate_beta** | åˆ©ç‡æ•æ„Ÿåº¦ | Rolling Corr(return, shibor_change, 60d) | è‚¡ç¥¨æ”¶ç›Šä¸åˆ©ç‡å˜åŒ–çš„ç›¸å…³æ€§ |
| **interest_rate_volatility** | åˆ©ç‡æ³¢åŠ¨æ€§ | Std(interest_rate_beta, 20d) | åˆ©ç‡æ•æ„Ÿåº¦çš„ç¨³å®šæ€§ |
| **inflation_beta** | é€šèƒ€æ•æ„Ÿåº¦ | Rolling Corr(return, cpi_change, 60d) | è‚¡ç¥¨æ”¶ç›Šä¸CPIçš„ç›¸å…³æ€§ |
| **cycle_beta** | ç»æµå‘¨æœŸæ•æ„Ÿåº¦ | Rolling Corr(return, pmi_change, 60d) | è‚¡ç¥¨æ”¶ç›Šä¸PMIçš„ç›¸å…³æ€§ |
| **monetary_beta** | è´§å¸æ”¿ç­–æ•æ„Ÿåº¦ | Rolling Corr(return, m2_change, 60d) | è‚¡ç¥¨æ”¶ç›Šä¸M2çš„ç›¸å…³æ€§ |
| **gdp_beta** | GDPå¢é•¿æ•æ„Ÿåº¦ | Rolling Corr(return, gdp_change, 120d) | è‚¡ç¥¨æ”¶ç›Šä¸GDPçš„ç›¸å…³æ€§ |
| **macro_risk_score** | ç»¼åˆå®è§‚é£é™© | Mean(abs(å„Beta)) | å¯¹å®è§‚å› ç´ çš„æ€»ä½“æ•æ„Ÿåº¦ |

### 3.2 å› å­è®¡ç®—é€»è¾‘

#### 3.2.1 åˆ©ç‡æ•æ„Ÿåº¦ (Interest Rate Beta)
```python
# 1. è®¡ç®—åˆ©ç‡å˜åŒ–
shibor_change = shibor_on.diff()

# 2. æ»šåŠ¨60æ—¥è®¡ç®—è‚¡ç¥¨æ”¶ç›Šä¸åˆ©ç‡çš„ç›¸å…³æ€§
interest_rate_beta = rolling_corr(return, shibor_change, window=60)

# è§£è¯»:
# Beta > 0: åˆ©ç‡ä¸Šå‡æ—¶è‚¡ä»·ä¸Šæ¶¨ï¼ˆç½•è§ï¼Œå¦‚é‡‘èè‚¡ï¼‰
# Beta < 0: åˆ©ç‡ä¸Šå‡æ—¶è‚¡ä»·ä¸‹è·Œï¼ˆå¸¸è§ï¼Œå¦‚åœ°äº§è‚¡ï¼‰
# |Beta|å¤§: å¯¹åˆ©ç‡å˜åŒ–æ•æ„Ÿ
```

#### 3.2.2 é€šèƒ€æ•æ„Ÿåº¦ (Inflation Beta)
```python
# CPIå˜åŒ–
cpi_change = cpi_yoy.diff()

# è‚¡ç¥¨æ”¶ç›Šä¸CPIçš„ç›¸å…³æ€§
inflation_beta = rolling_corr(return, cpi_change, window=60)

# è§£è¯»:
# Beta > 0: é€šèƒ€ä¸Šå‡æ—¶å—ç›Šï¼ˆå¦‚èµ„æºè‚¡ï¼‰
# Beta < 0: é€šèƒ€ä¸Šå‡æ—¶å—æŸï¼ˆå¦‚æ¶ˆè´¹è‚¡ï¼‰
```

#### 3.2.3 ç»æµå‘¨æœŸæ•æ„Ÿåº¦ (Cycle Beta)
```python
# PMIå˜åŒ–
pmi_change = pmi.diff()

# è‚¡ç¥¨æ”¶ç›Šä¸PMIçš„ç›¸å…³æ€§
cycle_beta = rolling_corr(return, pmi_change, window=60)

# è§£è¯»:
# Beta > 0: é¡ºå‘¨æœŸè‚¡ï¼ˆç»æµæ‰©å¼ æ—¶è¡¨ç°å¥½ï¼‰
# Beta < 0: é€†å‘¨æœŸè‚¡ï¼ˆç»æµæ”¶ç¼©æ—¶è¡¨ç°å¥½ï¼‰
# PMI > 50: ç»æµæ‰©å¼ æœŸ
# PMI < 50: ç»æµæ”¶ç¼©æœŸ
```

#### 3.2.4 è´§å¸æ”¿ç­–æ•æ„Ÿåº¦ (Monetary Beta)
```python
# M2å¢é€Ÿå˜åŒ–
m2_change = m2_yoy.diff()

# è‚¡ç¥¨æ”¶ç›Šä¸M2çš„ç›¸å…³æ€§
monetary_beta = rolling_corr(return, m2_change, window=60)

# è§£è¯»:
# Beta > 0: å®½æ¾è´§å¸æ”¿ç­–å—ç›Šï¼ˆå¦‚æˆé•¿è‚¡ï¼‰
# Beta < 0: ç´§ç¼©è´§å¸æ”¿ç­–å—ç›Šï¼ˆå¦‚é˜²å¾¡è‚¡ï¼‰
```

#### 3.2.5 å®è§‚é£é™©ç»¼åˆå¾—åˆ† (Macro Risk Score)
```python
# æ‰€æœ‰Betaå› å­çš„ç»å¯¹å€¼å¹³å‡
macro_beta_cols = ['interest_rate_beta', 'inflation_beta', 
                   'cycle_beta', 'monetary_beta']
macro_risk_score = abs(å„Beta).mean()

# è§£è¯»:
# é«˜åˆ†: å¯¹å®è§‚å› ç´ é«˜åº¦æ•æ„Ÿï¼Œå®è§‚é£é™©å¤§
# ä½åˆ†: å¯¹å®è§‚å› ç´ ä¸æ•æ„Ÿï¼Œå®è§‚é£é™©å°
```

### 3.3 å› å­æ€§èƒ½è¡¨ç°

**æœ¬æ¬¡æµ‹è¯•ç»“æœ** (30è‚¡ç¥¨, 2024å¹´1-10æœˆ):

| å› å­ | IC | ICIR | èƒœç‡ | æ’å |
|------|-----|------|------|------|
| macro_risk_score | 0.0133 | 0.0442 | 47.01% | ä¸­ç­‰ |
| interest_rate_beta | 0.0108 | 0.0380 | 51.28% | ä¸­ç­‰ |
| interest_rate_volatility | 0.0028 | 0.0101 | 49.07% | è¾ƒä½ |

**æ€§èƒ½åˆ†æ**:
- âœ… å®è§‚å› å­ICä¸ºæ­£ï¼Œè¡¨æ˜å…·æœ‰ä¸€å®šé¢„æµ‹èƒ½åŠ›
- âš ï¸ ICIRè¾ƒä½ï¼Œå¯èƒ½å› ä¸ºï¼š
  - æµ‹è¯•æ ·æœ¬å°ï¼ˆä»…30åªè‚¡ç¥¨ï¼‰
  - æ—¶é—´å‘¨æœŸçŸ­ï¼ˆ10ä¸ªæœˆï¼‰
  - éƒ¨åˆ†å®è§‚æ•°æ®ç¼ºå¤±ï¼ˆPMIã€GDPæœªæˆåŠŸåŠ è½½ï¼‰
- ğŸ” å»ºè®®æ‰©å¤§æ ·æœ¬å’Œæ—¶é—´èŒƒå›´è¿›ä¸€æ­¥éªŒè¯

---

## å››ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 ä»£ç ç»“æ„

**æ–‡ä»¶ä¿®æ”¹**:
1. `src/data/data_loader.py` - æ–°å¢å®è§‚æ•°æ®åŠ è½½
2. `src/factors/factor_calculator.py` - æ–°å¢å®è§‚å› å­è®¡ç®—
3. `main.py` - é›†æˆå®è§‚æ•°æ®åŠ è½½æµç¨‹

### 4.2 å…³é”®æŠ€æœ¯ç‚¹

#### 4.2.1 å¤šé¢‘ç‡æ•°æ®å¯¹é½
```python
# é—®é¢˜: å®è§‚æ•°æ®æ˜¯æœˆåº¦/å­£åº¦ï¼Œè‚¡ç¥¨æ•°æ®æ˜¯æ—¥åº¦
# è§£å†³: å‰å‘å¡«å…… + æ—¶é—´å¯¹é½

# 1. æœˆåº¦æ•°æ®è½¬æ—¥åº¦
macro_df = macro_df.set_index('date').resample('D').ffill()

# 2. ä¸è‚¡ç¥¨æ•°æ®åˆå¹¶
stock_data = pd.merge(stock_data, macro_df, on='date', how='left')

# æ•ˆæœ: æ¯ä¸ªäº¤æ˜“æ—¥éƒ½æœ‰æœ€æ–°çš„å®è§‚æ•°æ®
```

#### 4.2.2 æ»šåŠ¨ç›¸å…³æ€§è®¡ç®—
```python
# é—®é¢˜: éœ€è¦è®¡ç®—æ—¶å˜çš„Betaç³»æ•°
# è§£å†³: ä½¿ç”¨pandas rolling corr

# æŒ‰è‚¡ç¥¨åˆ†ç»„è®¡ç®—æ»šåŠ¨ç›¸å…³æ€§
df['interest_rate_beta'] = df.groupby('stock_code').apply(
    lambda x: x['return'].rolling(60).corr(x['shibor_change'])
).reset_index(level=0, drop=True)

# ä¼˜ç‚¹:
# - è‡ªåŠ¨å¤„ç†ç¼ºå¤±å€¼
# - è‡ªåŠ¨æŒ‰æ—¶é—´çª—å£è®¡ç®—
# - æ•æ‰æ—¶å˜å…³ç³»
```

#### 4.2.3 å®¹é”™æœºåˆ¶
```python
# é—®é¢˜: APIè°ƒç”¨å¯èƒ½å¤±è´¥
# è§£å†³: Try-exceptåŒ…è£¹ï¼Œéƒ¨åˆ†å¤±è´¥ä¸å½±å“å…¨å±€

try:
    cpi_data = load_cpi()
    macro_dfs.append(cpi_data)
    print("âœ“ CPIæ•°æ®åŠ è½½æˆåŠŸ")
except Exception as e:
    print(f"âœ— CPIæ•°æ®åŠ è½½å¤±è´¥: {e}")
    # ç»§ç»­åŠ è½½å…¶ä»–æ•°æ®ï¼Œä¸ä¸­æ–­

# ä¼˜ç‚¹: æé«˜ç³»ç»Ÿé²æ£’æ€§
```

### 4.3 æ€§èƒ½ä¼˜åŒ–

**æ•°æ®é‡å¯¹æ¯”**:
```
åŸå§‹è‚¡ç¥¨æ•°æ®:     5,969è¡Œ Ã— 15åˆ— = 89,535ä¸ªå€¼
åŠ è½½å®è§‚æ•°æ®:    26,939è¡Œ Ã— 9åˆ— = 242,451ä¸ªå€¼
åˆå¹¶åæ•°æ®:       5,969è¡Œ Ã— 25åˆ— = 149,225ä¸ªå€¼

å†…å­˜å¢åŠ : ~60KB (å®è§‚æ•°æ®é‡å¤è¾ƒå¤šï¼Œåˆå¹¶åå¢é‡å°)
åŠ è½½æ—¶é—´: +5ç§’ (å®è§‚æ•°æ®APIè°ƒç”¨)
```

---

## äº”ã€ä½¿ç”¨æŒ‡å—

### 5.1 å¯ç”¨å®è§‚å› å­

å®è§‚å› å­**é»˜è®¤å¯ç”¨**ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å®è§‚æ•°æ®å¯ç”¨æ€§ï¼š

```python
# è‡ªåŠ¨æ£€æµ‹é€»è¾‘ (åœ¨ factor_calculator.py)
has_macro_data = any(col in df.columns for col in 
                     ['cpi_yoy', 'pmi', 'm2_yoy', 'shibor_on', 'gdp_yoy'])

if has_macro_data:
    calculate_macro_factors()  # è‡ªåŠ¨è®¡ç®—
else:
    print("Skipping macro factors (no macro data)")
```

### 5.2 æŸ¥çœ‹å®è§‚æ•°æ®

```bash
# è¿è¡Œç³»ç»Ÿ
python main.py

# æŸ¥çœ‹æ—¥å¿—è¾“å‡º
# æœç´¢: "åŠ è½½å®è§‚ç»æµæ•°æ®"
# ç¡®è®¤: "âœ“ å®è§‚æ•°æ®åŠ è½½å®Œæˆ"
```

### 5.3 è‡ªå®šä¹‰å®è§‚å› å­

**æ·»åŠ æ–°çš„å®è§‚å› å­**:

```python
# åœ¨ factor_calculator.py çš„ calculate_macro_factors() ä¸­æ·»åŠ 

# ç¤ºä¾‹: æ·»åŠ æ±‡ç‡æ•æ„Ÿåº¦
if 'usd_cny' in df.columns:  # å‡è®¾æœ‰æ±‡ç‡æ•°æ®
    df['exchange_rate_change'] = df.groupby('stock_code')['usd_cny'].diff()
    
    df['fx_beta'] = df.groupby('stock_code', group_keys=False).apply(
        lambda x: x['return'].rolling(60).corr(x['exchange_rate_change'])
    ).reset_index(level=0, drop=True)
    
    print("  âœ“ FX sensitivity calculated")
```

---

## å…­ã€æ”¹è¿›å»ºè®®

### 6.1 çŸ­æœŸæ”¹è¿›

**1. å®Œå–„å®è§‚æ•°æ®åŠ è½½**
```python
# é—®é¢˜: PMIå’ŒGDPæ•°æ®åŠ è½½å¤±è´¥
# åŸå› : APIè¿”å›æ ¼å¼å˜åŒ–
# è§£å†³: æ›´æ–°æ•°æ®è§£æé€»è¾‘

# PMIæ•°æ®ä¿®å¤
pmi = self.pro.cn_pmi(...)
# æ£€æŸ¥è¿”å›çš„åˆ—åï¼Œè°ƒæ•´fieldå‚æ•°

# GDPå­£åº¦æ•°æ®ä¿®å¤  
gdp['date'] = pd.to_datetime(gdp['quarter'] + '01', format='%Y%m%d')
gdp['date'] = gdp['date'] + pd.offsets.QuarterEnd(0)
```

**2. å¢åŠ å®è§‚æŒ‡æ ‡**
- å·¥ä¸šå¢åŠ å€¼ (Industrial Production)
- ç¤¾ä¼šèèµ„è§„æ¨¡ (Social Financing)
- äººæ°‘å¸æ±‡ç‡ (CNY/USD)
- 10å¹´æœŸå›½å€ºæ”¶ç›Šç‡ (10Y Treasury Yield)
- ä¿¡ç”¨åˆ©å·® (Credit Spread)

**3. ä¼˜åŒ–çª—å£å‚æ•°**
```python
# å½“å‰: å›ºå®š60æ—¥çª—å£
# æ”¹è¿›: è‡ªé€‚åº”çª—å£æˆ–å¤šçª—å£

for window in [20, 60, 120]:  # çŸ­æœŸã€ä¸­æœŸã€é•¿æœŸ
    df[f'interest_rate_beta_{window}d'] = rolling_corr(
        return, shibor_change, window=window
    )
```

### 6.2 ä¸­æœŸæ”¹è¿›

**1. å®è§‚å› å­ç»„åˆ**
```python
# æ„å»ºå®è§‚ç¯å¢ƒç»¼åˆæŒ‡æ•°
macro_index = weighted_sum([
    normalize(pmi - 50),           # ç»æµæ´»åŠ¨
    normalize(2 - cpi_yoy),        # é€šèƒ€ç›®æ ‡
    normalize(m2_yoy - 10),        # è´§å¸ä¾›åº”
    normalize(-shibor_on)          # åˆ©ç‡æˆæœ¬
])

# æ ¹æ®å®è§‚ç¯å¢ƒè°ƒæ•´å› å­æƒé‡
if macro_index > 0:  # å®è§‚ç¯å¢ƒå¥½
    factor_weight['momentum'] *= 1.2  # åŠ å¤§åŠ¨é‡å› å­
else:  # å®è§‚ç¯å¢ƒå·®
    factor_weight['value'] *= 1.2     # åŠ å¤§ä»·å€¼å› å­
```

**2. å®è§‚é£é™©é¢„ç®—**
```python
# æ ¹æ®å®è§‚é£é™©åˆ†é…èµ„é‡‘
max_macro_risk = 0.5  # ç»„åˆæœ€å¤§å®è§‚é£é™©æ•å£

for stock in portfolio:
    risk = stock['macro_risk_score']
    weight = risk_budget / risk  # é«˜é£é™©ä½æƒé‡
    stock['position'] = weight
```

**3. æƒ…æ™¯åˆ†æ**
```python
# å®è§‚æƒ…æ™¯æµ‹è¯•
scenarios = {
    'åŠ æ¯': {'shibor_on': +0.5},
    'é€šèƒ€': {'cpi_yoy': +2.0},
    'è¡°é€€': {'pmi': -10}
}

for name, shock in scenarios.items():
    portfolio_return = simulate_shock(portfolio, shock)
    print(f"{name}æƒ…æ™¯: {portfolio_return:.2%}")
```

### 6.3 é•¿æœŸæ”¹è¿›

**1. æœºå™¨å­¦ä¹ å®è§‚é¢„æµ‹**
```python
# ä½¿ç”¨MLé¢„æµ‹æœªæ¥å®è§‚ç¯å¢ƒ
from xgboost import XGBRegressor

# ç‰¹å¾: å†å²å®è§‚æ•°æ®
X = macro_history[['cpi', 'pmi', 'm2', 'shibor']]

# æ ‡ç­¾: æœªæ¥è‚¡ç¥¨æ”¶ç›Š
y = future_returns

# è®­ç»ƒæ¨¡å‹
model = XGBRegressor()
model.fit(X, y)

# é¢„æµ‹
macro_forecast = model.predict(current_macro)
```

**2. å®è§‚å› å­åŠ¨æ€åŠ æƒ**
```python
# æ ¹æ®å®è§‚regimeåˆ‡æ¢å› å­æƒé‡
current_regime = identify_regime(macro_data)  # æ‰©å¼ /è¡°é€€/æ»èƒ€

if current_regime == 'æ‰©å¼ ':
    weights = {'momentum': 0.4, 'value': 0.2, 'quality': 0.4}
elif current_regime == 'è¡°é€€':
    weights = {'momentum': 0.2, 'value': 0.4, 'quality': 0.4}
elif current_regime == 'æ»èƒ€':
    weights = {'momentum': 0.2, 'value': 0.3, 'quality': 0.5}
```

---

## ä¸ƒã€æ€§èƒ½è¯„ä¼°

### 7.1 ç³»ç»Ÿæ€§èƒ½

**æ‰§è¡Œæ—¶é—´å¯¹æ¯”**:
```
ä¼˜åŒ–å‰: ~53ç§’
ä¼˜åŒ–å: ~58ç§’
å¢åŠ : +5ç§’ (å®è§‚æ•°æ®åŠ è½½å’Œå› å­è®¡ç®—)
```

**å†…å­˜å ç”¨**:
```
ä¼˜åŒ–å‰: 0.51 MB
ä¼˜åŒ–å: 0.57 MB  
å¢åŠ : +0.06 MB
```

**å› å­æ•°é‡**:
```
ä¼˜åŒ–å‰: 81ä¸ªè®¡ç®—å› å­
ä¼˜åŒ–å: 88ä¸ªè®¡ç®—å› å­ (+7ä¸ªå®è§‚å› å­)
æœ€ç»ˆé€‰ä¸­: 12ä¸ª (åŒ…å«å®è§‚å› å­)
```

### 7.2 å› å­è´¨é‡

**å®è§‚å› å­ICåˆ†å¸ƒ**:
```
macro_risk_score:          IC=0.0133, ICIR=0.0442
interest_rate_beta:        IC=0.0108, ICIR=0.0380
interest_rate_volatility:  IC=0.0028, ICIR=0.0101
```

**å¯¹æ¯”å…¶ä»–å› å­**:
```
ä»·æ ¼å½¢æ€ (new_low_20d):    IC=0.3532, ICIR=3.5430  â­
ä¼°å€¼å› å­ (BP):             IC=0.1619, ICIR=0.4996  â­
æµåŠ¨æ€§ (amihud_20d):       IC=0.0656, ICIR=0.2622  
å®è§‚é£é™© (macro_risk):     IC=0.0133, ICIR=0.0442  âœ“
```

**ç»“è®º**: å®è§‚å› å­è¡¨ç°ä¸­ç­‰ï¼Œä½œä¸ºè¾…åŠ©å› å­æœ‰ä»·å€¼

---

## å…«ã€æ€»ç»“

### 8.1 ä¸»è¦æˆå°±

âœ… **æ•°æ®æºæ‰©å±•**: æˆåŠŸé›†æˆ5ç±»å®è§‚ç»æµæ•°æ®  
âœ… **å› å­åˆ›æ–°**: æ–°å¢7ä¸ªå®è§‚æ•æ„Ÿåº¦å› å­  
âœ… **ç³»ç»Ÿå®Œæ•´**: å®ç°æ•°æ®åŠ è½½â†’å› å­è®¡ç®—â†’è¯„ä¼°ç­›é€‰å…¨æµç¨‹  
âœ… **æ€§èƒ½éªŒè¯**: å®è§‚å› å­ICä¸ºæ­£ï¼Œå…·æœ‰é¢„æµ‹èƒ½åŠ›  
âœ… **ä»£ç è´¨é‡**: å®¹é”™æœºåˆ¶å®Œå–„ï¼Œå¯æ‰©å±•æ€§å¼º

### 8.2 æŠ€æœ¯äº®ç‚¹

1. **å¤šé¢‘ç‡å¯¹é½**: ä¼˜é›…å¤„ç†æ—¥åº¦/æœˆåº¦/å­£åº¦æ•°æ®æ··åˆ
2. **æ»šåŠ¨ç›¸å…³æ€§**: æ•æ‰è‚¡ç¥¨ä¸å®è§‚å˜é‡çš„æ—¶å˜å…³ç³»
3. **è‡ªåŠ¨æ£€æµ‹**: æ™ºèƒ½åˆ¤æ–­æ•°æ®å¯ç”¨æ€§ï¼Œè‡ªåŠ¨è®¡ç®—ç›¸åº”å› å­
4. **å®¹é”™è®¾è®¡**: å•ä¸ªæ•°æ®æºå¤±è´¥ä¸å½±å“æ•´ä½“è¿è¡Œ
5. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œæ”¹è¿›å»ºè®®

### 8.3 ä¸‹ä¸€æ­¥è®¡åˆ’

**ä¼˜å…ˆçº§1** (é«˜):
- ä¿®å¤PMIå’ŒGDPæ•°æ®åŠ è½½é—®é¢˜
- æ‰©å¤§æµ‹è¯•æ ·æœ¬ï¼ˆ100+è‚¡ç¥¨ï¼Œ2+å¹´ï¼‰
- å®Œå–„å®è§‚å› å­å‚æ•°è°ƒä¼˜

**ä¼˜å…ˆçº§2** (ä¸­):
- æ–°å¢æ›´å¤šå®è§‚æŒ‡æ ‡ï¼ˆæ±‡ç‡ã€åˆ©å·®ã€ä¿¡è´·ï¼‰
- å®ç°å®è§‚å› å­ç»„åˆå’Œæƒ…æ™¯åˆ†æ
- å¼€å‘å®è§‚é£é™©é¢„ç®—æ¨¡å—

**ä¼˜å…ˆçº§3** (ä½):
- æœºå™¨å­¦ä¹ å®è§‚é¢„æµ‹
- å®è§‚regimeè¯†åˆ«å’ŒåŠ¨æ€é…ç½®
- å®è§‚å› å­å›æµ‹å½’å› åˆ†æ

---

## é™„å½•ï¼šä»£ç ç¤ºä¾‹

### A.1 å®è§‚æ•°æ®åŠ è½½

```python
# data_loader.py
def load_macro_data(self, start_date: str, end_date: str):
    """åŠ è½½å®è§‚ç»æµæ•°æ®"""
    
    # 1. åŠ è½½CPI
    cpi = self.pro.cn_cpi(start_date=start_date[:6], end_date=end_date[:6])
    
    # 2. åŠ è½½M2
    m2 = self.pro.cn_m(start_date=start_date[:6], end_date=end_date[:6])
    
    # 3. åŠ è½½Shibor
    shibor = self.pro.shibor(start_date=start_date, end_date=end_date)
    
    # 4. åˆå¹¶å¹¶å¯¹é½
    macro_df = merge_and_align(cpi, m2, shibor)
    
    # 5. æ—¥åº¦å¡«å……
    macro_df = macro_df.resample('D').ffill()
    
    return macro_df
```

### A.2 å®è§‚å› å­è®¡ç®—

```python
# factor_calculator.py
def calculate_macro_factors(self):
    """è®¡ç®—å®è§‚æ•æ„Ÿåº¦å› å­"""
    
    # åˆ©ç‡æ•æ„Ÿåº¦
    df['shibor_change'] = df.groupby('stock_code')['shibor_on'].diff()
    df['interest_rate_beta'] = df.groupby('stock_code').apply(
        lambda x: x['return'].rolling(60).corr(x['shibor_change'])
    )
    
    # é€šèƒ€æ•æ„Ÿåº¦
    df['cpi_change'] = df.groupby('stock_code')['cpi_yoy'].diff()
    df['inflation_beta'] = df.groupby('stock_code').apply(
        lambda x: x['return'].rolling(60).corr(x['cpi_change'])
    )
    
    # ç»¼åˆå®è§‚é£é™©
    beta_cols = ['interest_rate_beta', 'inflation_beta']
    df['macro_risk_score'] = df[beta_cols].abs().mean(axis=1)
    
    return df
```

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-11-03 20:25  
**ä¼˜åŒ–çŠ¶æ€**: âœ… å®è§‚å› å­å®ç°å®Œæˆ  
**ç³»ç»Ÿç‰ˆæœ¬**: v2.1  
**ä¸‹ä¸€æ­¥**: æ‰©å¤§æ ·æœ¬éªŒè¯ + ä¿®å¤PMI/GDPæ•°æ®
