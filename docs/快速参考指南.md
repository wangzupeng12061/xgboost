# XGBoostå¤šå› å­é€‰è‚¡ç³»ç»Ÿ - å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸ“Š ç³»ç»Ÿç°çŠ¶æ€»è§ˆ

### âœ… å·²å®ç°åŠŸèƒ½
- **æ•°æ®åŠ è½½**: ä»·æ ¼ + å¸‚å€¼ + è¡Œä¸š + è´¢åŠ¡æŒ‡æ ‡ + å®è§‚æ•°æ®
- **å› å­è®¡ç®—**: 88ä¸ªå› å­ï¼ˆ8å¤§ç±»åˆ«ï¼‰
- **å› å­é¢„å¤„ç†**: å»æå€¼ã€æ ‡å‡†åŒ–ã€ä¸­æ€§åŒ–
- **å› å­ç­›é€‰**: æ™ºèƒ½ICç­›é€‰ï¼ˆ12ä¸ªæœ€ç»ˆå› å­ï¼‰
- **æ ‡ç­¾æ„å»º**: åˆ†ç±»/å›å½’æ ‡ç­¾
- **å®Œæ•´æµç¨‹**: æ•°æ®â†’å› å­â†’ç­›é€‰â†’æ ‡ç­¾

### ğŸ¯ æ ¸å¿ƒæŒ‡æ ‡
```
æ•°æ®é‡:     30è‚¡ç¥¨ Ã— 147å¤© = 2893æ¡è®°å½•
å› å­æ•°:     88è®¡ç®— â†’ 87é¢„å¤„ç† â†’ 12é€‰ä¸­
ç­›é€‰ç‡:     13.8% (ä¼˜åŒ–å‰: 2.5%)
æ‰§è¡Œæ—¶é—´:   ~58ç§’
Topå› å­:    new_low_20d (ICIR=3.54)
å®è§‚å› å­:   3ä¸ª (åˆ©ç‡Betaã€å®è§‚é£é™©ç­‰)
```

### ğŸ†• æœ€æ–°æ›´æ–° (v2.1)
- âœ¨ **å®è§‚æ•°æ®æº**: CPIã€M2ã€Shiboråˆ©ç‡
- âœ¨ **å®è§‚å› å­**: 7ä¸ªæ•æ„Ÿåº¦å› å­
- âœ¨ **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨åˆ¤æ–­å®è§‚æ•°æ®å¯ç”¨æ€§

---

## ğŸš€ å¿«é€Ÿæ“ä½œ

### è¿è¡Œç³»ç»Ÿ
```bash
cd /Users/wangzupeng/Program/xgboost
source .venv/bin/activate
python main.py
```

### è°ƒæ•´ç­›é€‰ç­–ç•¥
```yaml
# config/config.yaml
factors:
  selection:
    ic_threshold: 0.01      # â†“é™ä½ä¿ç•™æ›´å¤šå› å­
    icir_threshold: 0.1     # â†“é™ä½æ”¾å®½è¦æ±‚
    min_factors: 10         # æœ€å°‘ä¿ç•™æ•°é‡
    max_factors: 30         # æœ€å¤šä¿ç•™æ•°é‡
```

### æ‰©å±•è‚¡ç¥¨æ± 
```yaml
# config/config.yaml
data:
  universe: 'all'           # 'hs300', 'zz500', 'all'
  # main.py ä¸­ä¿®æ”¹å–æ ·æ•°é‡
  stock_codes = stock_list['stock_code'].tolist()[:100]  # 30æ”¹ä¸º100
```

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶è·¯å¾„

```
xgboost/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.yaml                      # âš™ï¸ é…ç½®æ–‡ä»¶ï¼ˆé˜ˆå€¼è°ƒæ•´åœ¨è¿™é‡Œï¼‰
â”œâ”€â”€ main.py                              # ğŸ¯ ä¸»ç¨‹åºï¼ˆæµç¨‹ç¼–æ’ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ data_loader.py              # ğŸ“¥ æ•°æ®åŠ è½½ï¼ˆä»·æ ¼+å¸‚å€¼+è¡Œä¸š+è´¢åŠ¡+å®è§‚ï¼‰
â”‚   â”‚   â””â”€â”€ data_processor.py           # ğŸ”§ æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ factors/
â”‚   â”‚   â”œâ”€â”€ factor_calculator.py        # ğŸ§® å› å­è®¡ç®—ï¼ˆ8å¤§ç±»88ä¸ªå› å­ï¼‰
â”‚   â”‚   â”œâ”€â”€ factor_processor.py         # ğŸ”¨ å› å­é¢„å¤„ç†
â”‚   â”‚   â””â”€â”€ factor_selector.py          # ğŸ¯ å› å­ç­›é€‰
â”‚   â””â”€â”€ model/
â”‚       â””â”€â”€ label_builder.py            # ğŸ·ï¸ æ ‡ç­¾æ„å»º
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md                  # ğŸ“„ ç¬¬ä¸€é˜¶æ®µä¼˜åŒ–æŠ¥å‘Š
â”‚   â”œâ”€â”€ å®è§‚å› å­ä¼˜åŒ–æŠ¥å‘Š.md              # ğŸ“„ å®è§‚å› å­è¯¦ç»†è¯´æ˜
â”‚   â””â”€â”€ å¿«é€Ÿå‚è€ƒæŒ‡å—.md                  # ğŸ“˜ æœ¬æ–‡æ¡£
â””â”€â”€ logs/                                # ğŸ“ è¿è¡Œæ—¥å¿—
```

---

## ğŸ”§ æ·»åŠ æ–°å› å­

### Step 1: åœ¨ factor_calculator.py ä¸­å®šä¹‰
```python
def calculate_custom_factors(self) -> pd.DataFrame:
    """è®¡ç®—è‡ªå®šä¹‰å› å­"""
    df = self.data.copy()
    
    # ç¤ºä¾‹1ï¼šè®¡ç®—ä»·æ ¼æŒ¯å¹…å› å­
    df['price_amplitude'] = (df['high'] - df['low']) / df['close']
    
    # ç¤ºä¾‹2ï¼šæ»šåŠ¨çª—å£å› å­
    df['amplitude_20d'] = df.groupby('stock_code')['price_amplitude'].rolling(20).mean().reset_index(0, drop=True)
    
    # ç¤ºä¾‹3ï¼šå®è§‚å› å­ï¼ˆå¦‚æœæœ‰å®è§‚æ•°æ®ï¼‰
    if 'usd_cny' in df.columns:
        df['fx_change'] = df.groupby('stock_code')['usd_cny'].diff()
        df['fx_beta'] = df.groupby('stock_code', group_keys=False).apply(
            lambda x: x['return'].rolling(60).corr(x['fx_change'])
        ).reset_index(level=0, drop=True)
    
    return df
```

### Step 2: åœ¨ calculate_all_factors ä¸­è°ƒç”¨
```python
def calculate_all_factors(self):
    # ... ç°æœ‰å› å­è®¡ç®— ...
    
    # æ·»åŠ è‡ªå®šä¹‰å› å­
    df = self.calculate_custom_factors()
    self.data = df
    print("  âœ“ Custom factors completed")
    
    # ... è¿”å›ç»“æœ ...
```

### Step 3: æµ‹è¯•
```bash
python main.py
# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ–°å› å­è¢«è®¡ç®—å’Œè¯„ä¼°
```

---

## ğŸ“Š 12ä¸ªæœ€ç»ˆå› å­é€ŸæŸ¥

| å› å­ | ç±»åˆ« | ICIR | è¯´æ˜ |
|------|------|------|------|
| new_low_20d | ä»·æ ¼ | 3.54 | â­æ ¸å¿ƒå› å­ |
| BP | ä¼°å€¼ | 0.50 | è´¦é¢å¸‚å€¼æ¯” |
| amihud_20d | æµåŠ¨æ€§ | 0.26 | éæµåŠ¨æ€§ |
| close_to_ma60 | æŠ€æœ¯ | 0.22 | MA60åç¦»åº¦ |
| float_market_cap | å¸‚å€¼ | 0.21 | æµé€šå¸‚å€¼ |
| avg_amount_60d | æµåŠ¨æ€§ | 0.20 | 60æ—¥æˆäº¤é¢ |
| market_cap | å¸‚å€¼ | 0.20 | æ€»å¸‚å€¼ |
| log_float_cap | å¸‚å€¼ | 0.19 | å¯¹æ•°å¸‚å€¼ |
| price_position_60d | ä»·æ ¼ | 0.17 | 60æ—¥ä½ç½® |
| max_drawdown_60d | é£é™© | 0.14 | 60æ—¥å›æ’¤ |
| return_60d | åŠ¨é‡ | 0.11 | 60æ—¥æ”¶ç›Š |
| EP | ä¼°å€¼ | 0.11 | ç›ˆåˆ©æ”¶ç›Šç‡ |

---

## ğŸ” é—®é¢˜æ’æŸ¥

### é—®é¢˜1: å› å­æ•°é‡å¤ªå°‘
**è§£å†³æ–¹æ¡ˆ**:
```yaml
# config.yaml é™ä½é˜ˆå€¼
ic_threshold: 0.005     # è¿›ä¸€æ­¥é™ä½
icir_threshold: 0.05    # è¿›ä¸€æ­¥é™ä½
min_factors: 15         # æé«˜æœ€å°æ•°é‡
```

### é—®é¢˜2: å› å­æ•°é‡å¤ªå¤šï¼ˆè¿‡æ‹Ÿåˆé£é™©ï¼‰
**è§£å†³æ–¹æ¡ˆ**:
```yaml
# config.yaml æé«˜é˜ˆå€¼
ic_threshold: 0.02      # æé«˜è¦æ±‚
icir_threshold: 0.2     # æé«˜è¦æ±‚
max_factors: 20         # é™ä½æœ€å¤§æ•°é‡
correlation_threshold: 0.7  # é™ä½ç›¸å…³æ€§å®¹å¿åº¦
```

### é—®é¢˜3: æ•°æ®åŠ è½½å¤±è´¥
**æ£€æŸ¥ç‚¹**:
```python
# 1. Tushare token æ˜¯å¦æœ‰æ•ˆ
config['data']['token'] = "your_token_here"

# 2. APIè°ƒç”¨é¢‘ç‡æ˜¯å¦è¶…é™
import time
time.sleep(0.2)  # å¢åŠ å»¶è¿Ÿ

# 3. è‚¡ç¥¨ä»£ç æ ¼å¼æ˜¯å¦æ­£ç¡®
# æ­£ç¡®: '000001.SZ', '600000.SH'
# é”™è¯¯: '000001', 'SZ000001'
```

### é—®é¢˜4: è¡Œä¸šæ•°æ®ç¼ºå¤±
**åŸå› **: æŸäº›è‚¡ç¥¨åœ¨Tushareä¸­æ²¡æœ‰è¡Œä¸šåˆ†ç±»
**å½±å“**: è¡Œä¸šè½®åŠ¨å› å­å’Œè¡Œä¸šä¸­æ€§åŒ–è·³è¿‡
**è§£å†³**: ä½¿ç”¨æ›´å…¨çš„è¡Œä¸šåˆ†ç±»æ•°æ®æºï¼Œæˆ–æ‰‹åŠ¨è¡¥å……

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### åŠ é€Ÿæ•°æ®åŠ è½½
```python
# 1. å‡å°‘å¸‚å€¼æ•°æ®é‡‡æ ·é¢‘ç‡
sample_dates = trade_dates[::10]  # 5æ”¹ä¸º10ï¼Œæ¯10å¤©é‡‡æ ·ä¸€æ¬¡

# 2. é™åˆ¶è´¢åŠ¡æ•°æ®åŠ è½½èŒƒå›´
# åªåŠ è½½æ ¸å¿ƒæŒ‡æ ‡
indicators = ['roe', 'roa', 'debt_to_assets']

# 3. å®è§‚æ•°æ®ç¼“å­˜
# å®è§‚æ•°æ®å˜åŒ–æ…¢ï¼Œå¯ä»¥ç¼“å­˜é‡ç”¨
if os.path.exists('cache/macro_data.pkl'):
    macro_data = pd.read_pickle('cache/macro_data.pkl')
else:
    macro_data = loader.load_macro_data(...)
    macro_data.to_pickle('cache/macro_data.pkl')
```

### åŠ é€Ÿå› å­è®¡ç®—
```python
# 1. å¹¶è¡Œè®¡ç®—ï¼ˆä½¿ç”¨multiprocessingï¼‰
from multiprocessing import Pool
with Pool(4) as p:
    results = p.map(calculate_factor, factor_list)

# 2. å‘é‡åŒ–è¿ç®—ï¼ˆé¿å…å¾ªç¯ï¼‰
# å·®: for i in range(len(df)): df.loc[i, 'factor'] = ...
# å¥½: df['factor'] = df['close'].pct_change(20)

# 3. å‡å°‘æ»šåŠ¨çª—å£è®¡ç®—
# å¯¹äºå®è§‚å› å­ï¼Œå¯ä»¥ç”¨æ›´é•¿çš„çª—å£å‡å°‘è®¡ç®—é‡
# rolling(60) æ”¹ä¸º rolling(120) æˆ– expanding()
```

---

## ğŸ“ è¿›é˜¶åŠŸèƒ½å¼€å‘

### 1. å®è§‚å› å­é›†æˆ
```python
# data_loader.py æ–°å¢æ–¹æ³•
def load_macro_data(self, start_date, end_date):
    """åŠ è½½å®è§‚æ•°æ®ï¼šåˆ©ç‡ã€CPIã€PMIç­‰"""
    macro_df = self.pro.macro_china(
        start_date=start_date,
        end_date=end_date
    )
    return macro_df

# factor_calculator.py æ–°å¢æ–¹æ³•
def calculate_macro_factors(self):
    """è®¡ç®—å®è§‚æ•æ„Ÿåº¦å› å­"""
    # è‚¡ç¥¨æ”¶ç›Šä¸åˆ©ç‡çš„æ»šåŠ¨ç›¸å…³ç³»æ•°
    df['interest_rate_beta'] = rolling_correlation(
        df['return'], macro['interest_rate'], window=60
    )
    return df
```

### 2. å¤šå› å­åŠ æƒ
```python
# factor_selector.py æ–°å¢æ–¹æ³•
def calculate_factor_weights(self, method='ic'):
    """è®¡ç®—å› å­æƒé‡"""
    if method == 'ic':
        # ICåŠ æƒ
        weights = abs(ic_values) / abs(ic_values).sum()
    elif method == 'equal_risk':
        # ç­‰é£é™©è´¡çŒ®
        weights = 1 / factor_volatility
        weights = weights / weights.sum()
    return weights
```

### 3. å›æµ‹å¢å¼º
```python
# backtester.py å¢å¼º
def backtest_with_cost(self, commission=0.0003, slippage=0.001):
    """è€ƒè™‘äº¤æ˜“æˆæœ¬çš„å›æµ‹"""
    # è®¡ç®—æ¢æ‰‹ç‡
    turnover = calculate_turnover(positions)
    # æ‰£é™¤æˆæœ¬
    returns = raw_returns - turnover * (commission + slippage)
    return returns
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å› å­è§£é‡Š
- **new_low_20d**: 20æ—¥å†…åˆ›æ–°ä½çš„æ¬¡æ•°ï¼Œå€¼è¶Šå¤§è¶Šå¼±åŠ¿
- **BP (Book-to-Price)**: è´¦é¢ä»·å€¼/å¸‚å€¼ï¼Œä»·å€¼å› å­
- **Amihud**: éæµåŠ¨æ€§æŒ‡æ ‡ï¼Œå€¼è¶Šå¤§æµåŠ¨æ€§è¶Šå·®
- **ICIR**: ICå‡å€¼/ICæ ‡å‡†å·®ï¼Œå› å­ç¨³å®šæ€§æŒ‡æ ‡

### é…ç½®å‚æ•°è¯´æ˜
```yaml
ic_threshold: 0.01
  # IC(Information Coefficient)é˜ˆå€¼
  # å–å€¼èŒƒå›´: 0.01-0.05
  # è¶Šé«˜è¶Šä¸¥æ ¼ï¼Œä¿ç•™çš„å› å­è¶Šå°‘

icir_threshold: 0.1
  # ICIR = ICå‡å€¼ / ICæ ‡å‡†å·®
  # å–å€¼èŒƒå›´: 0.1-0.5
  # è¡¡é‡å› å­çš„é£é™©è°ƒæ•´åè¡¨ç°

correlation_threshold: 0.8
  # å› å­ç›¸å…³æ€§é˜ˆå€¼
  # å–å€¼èŒƒå›´: 0.6-0.9
  # è¶…è¿‡æ­¤å€¼çš„å› å­å¯¹ä¼šå»é™¤ä¸€ä¸ª
```

### Tushare APIé™åˆ¶
```
æ™®é€šç”¨æˆ·:
- æ¯åˆ†é’Ÿè°ƒç”¨: 200æ¬¡
- æ¯å¤©è°ƒç”¨: 10000æ¬¡
- ç§¯åˆ†è¦æ±‚: 2000åˆ†ï¼ˆå®åè®¤è¯åï¼‰

å»ºè®®:
1. æ·»åŠ  time.sleep(0.1) é¿å…è¶…é¢‘
2. ç¼“å­˜å·²ä¸‹è½½æ•°æ®
3. ä½¿ç”¨é‡‡æ ·å‡å°‘APIè°ƒç”¨
```

---

## ğŸ› å¸¸è§é”™è¯¯åŠè§£å†³

### Error 1: "tushare token is required"
```python
# config.yaml æ£€æŸ¥tokené…ç½®
data:
  source: 'tushare'
  token: 'ä½ çš„token'  # ä¸èƒ½ä¸ºç©º
```

### Error 2: "left keys must be sorted"
```python
# åœ¨merge_asofå‰ç¡®ä¿æ’åº
df = df.sort_values(['stock_code', 'date']).reset_index(drop=True)
```

### Error 3: "KeyError: 'industry'"
```python
# æ£€æŸ¥è¡Œä¸šæ•°æ®æ˜¯å¦åŠ è½½æˆåŠŸ
if 'industry' in df.columns:
    calculate_industry_factors()
else:
    print("Skipping industry factors")
```

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

**æ–‡æ¡£ä½ç½®**: `/Users/wangzupeng/Program/xgboost/docs/`
- `ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` - è¯¦ç»†ä¼˜åŒ–è¯´æ˜
- `å¿«é€Ÿå‚è€ƒæŒ‡å—.md` - æœ¬æ–‡æ¡£

**æ—¥å¿—ä½ç½®**: `/Users/wangzupeng/Program/xgboost/logs/`
- æ¯æ¬¡è¿è¡Œç”Ÿæˆæ–°æ—¥å¿—æ–‡ä»¶
- æ–‡ä»¶å: `xgboost_stock_YYYYMMDD_HHMMSS.log`

**ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®**:
1. â­ å®ç°å¤šå› å­åŠ æƒï¼ˆICåŠ æƒ/ç­‰é£é™©ï¼‰
2. â­ å¢åŠ å›æµ‹äº¤æ˜“æˆæœ¬æ¨¡æ‹Ÿ
3. âœ… ~~é›†æˆå®è§‚æ•°æ®å’Œå®è§‚å› å­~~ (å·²å®Œæˆ)
4. ğŸŒŸ å®Œå–„å®è§‚æ•°æ®ï¼ˆä¿®å¤PMI/GDPåŠ è½½ï¼‰
5. ğŸŒŸ å®ç°ç»„åˆé£é™©ç®¡ç†æ¨¡å—

---

**æœ€åæ›´æ–°**: 2025-11-03  
**ç³»ç»Ÿç‰ˆæœ¬**: v2.1  
**ä¼˜åŒ–çŠ¶æ€**: âœ… å®è§‚å› å­å·²å®Œæˆ
