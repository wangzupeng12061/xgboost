# 批量下载多市场股票数据指南

> 支持A股、港股、美股等多个市场，自动分批次下载，避免API限流

## 📋 功能特点

- ✅ **多市场支持**: A股、港股、美股
- ✅ **分批下载**: 每批50只股票，自动等待避免限流
- ✅ **断点续传**: 已下载数据自动跳过
- ✅ **智能重试**: API失败自动重试3次
- ✅ **缓存管理**: 数据自动保存到本地
- ✅ **进度跟踪**: 实时显示下载进度和统计
- ✅ **灵活配置**: 支持自定义日期、数量、批次大小

## 🚀 快速开始

### 方法1: 使用交互式脚本（推荐）

```bash
chmod +x scripts/download_data.sh
./scripts/download_data.sh
```

按提示选择：
- 市场类型（A股/港股/美股/全部）
- 下载数量（默认1000只）
- 批次大小（默认50只）
- 日期范围（默认2020-2025）

### 方法2: 直接运行Python脚本

```bash
# A股，1000只，2020-2025
python scripts/batch_download_data.py \
    --market a \
    --total 1000 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04

# 港股，500只
python scripts/batch_download_data.py \
    --market hk \
    --total 500 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04

# 全部市场，1000只
python scripts/batch_download_data.py \
    --market all \
    --total 1000 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04
```

## 📊 参数说明

| 参数 | 说明 | 默认值 | 可选值 |
|------|------|--------|--------|
| --market | 市场类型 | a | a, hk, us, all |
| --total | 下载股票数量 | 1000 | 任意整数 |
| --batch-size | 每批次数量 | 50 | 建议20-50 |
| --start-date | 开始日期 | 2020-01-01 | YYYY-MM-DD |
| --end-date | 结束日期 | 2025-11-04 | YYYY-MM-DD |
| --token | Tushare token | 从config读取 | 你的token |
| --cache-dir | 缓存目录 | ./data | 任意路径 |

## 💡 使用场景

### 场景1: 下载A股Top1000（2020-2025）

```bash
python scripts/batch_download_data.py \
    --market a \
    --total 1000 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04
```

**预计时间**: 约30-40分钟（含等待时间）

### 场景2: 下载港股Top500

```bash
python scripts/batch_download_data.py \
    --market hk \
    --total 500 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04
```

**预计时间**: 约15-20分钟

### 场景3: 多市场混合下载

```bash
python scripts/batch_download_data.py \
    --market all \
    --total 1000 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04
```

**预计时间**: 约30-40分钟

### 场景4: 只下载最近1年数据（快速测试）

```bash
python scripts/batch_download_data.py \
    --market a \
    --total 100 \
    --batch-size 50 \
    --start-date 2024-01-01 \
    --end-date 2025-11-04
```

**预计时间**: 约3-5分钟

## 📈 时间估算

| 场景 | 股票数 | 年份 | 批次数 | 预计时间 |
|------|--------|------|--------|----------|
| 小规模测试 | 100 | 1年 | 2 | 3-5分钟 |
| 中等规模 | 500 | 5年 | 10 | 15-20分钟 |
| **大规模** | **1000** | **5年** | **20** | **30-40分钟** |
| 超大规模 | 2000 | 5年 | 40 | 60-80分钟 |

**说明**: 
- 每批50只股票，约1.5-2分钟
- 批次间等待60秒（避免限流）
- 已有缓存的股票会自动跳过

## 🔍 下载进度监控

脚本会实时显示：

```
======================================================================
批次 1/20
处理股票: 1-50/1000
======================================================================
下载 000001.SZ (A股) 数据: 2020-01-01 至 2025-11-04
✓ 000001.SZ 下载成功，数据量: 1234
下载 000002.SZ (A股) 数据: 2020-01-01 至 2025-11-04
✓ 000002.SZ 下载成功，数据量: 1200
...
批次 1 完成，耗时: 95.3秒
等待 60 秒后继续下一批次...
```

## 📁 数据存储结构

下载的数据保存在：

```
data/
├── stock_daily/
│   ├── 000001.SZ.csv      # A股数据
│   ├── 000002.SZ.csv
│   ├── 00700.HK.csv       # 港股数据
│   ├── AAPL.O.csv         # 美股数据
│   └── ...
└── stock_list_a_20251104_153045.csv  # 股票列表快照
```

## 🛡️ API限流处理

脚本内置完善的限流保护：

### 1. 频率控制
- 每次API调用间隔0.5秒
- 每分钟最多180次调用
- 达到限制自动等待60秒

### 2. 批次管理
- 每批50只股票
- 批次间自动等待60秒
- 重置API调用计数

### 3. 智能重试
- API失败自动重试3次
- 检测到限流错误立即等待
- 避免无效重试浪费配额

## 💾 断点续传

脚本支持断点续传，意外中断后可继续：

```bash
# 中断后重新运行相同命令
python scripts/batch_download_data.py \
    --market a \
    --total 1000 \
    --batch-size 50 \
    --start-date 2020-01-01 \
    --end-date 2025-11-04

# 已下载的股票会自动跳过
# [1/50] 000001.SZ - 已缓存，跳过
# [2/50] 000002.SZ - 已缓存，跳过
# [3/50] 000003.SZ - 下载中...
```

## 📊 下载完成统计

下载完成后会显示详细统计：

```
======================================================================
下载完成!
总计: 1000 只股票
成功: 950 只
跳过: 30 只 (已有缓存)
失败: 20 只
======================================================================

缓存统计:
  股票数据文件: 980
  总大小: 245.6 MB
======================================================================
```

## 🔧 高级用法

### 1. 自定义Token

```bash
python scripts/batch_download_data.py \
    --token your_tushare_token_here \
    --market a \
    --total 1000
```

### 2. 自定义缓存目录

```bash
python scripts/batch_download_data.py \
    --cache-dir /path/to/custom/cache \
    --market a \
    --total 1000
```

### 3. 调整批次大小

```bash
# 更保守（更慢但更稳定）
python scripts/batch_download_data.py \
    --batch-size 20 \
    --market a \
    --total 1000

# 更激进（更快但可能限流）
python scripts/batch_download_data.py \
    --batch-size 100 \
    --market a \
    --total 1000
```

## ⚠️ 注意事项

### 1. API权限要求

| 市场 | 权限要求 | Tushare积分 |
|------|----------|-------------|
| A股 | 基础权限 | 0分即可 |
| 港股 | 基础权限 | 0分即可 |
| 美股 | **高级权限** | **需要120分+** |

如果美股下载失败，可能需要升级Tushare权限。

### 2. 网络稳定性

- 建议在稳定网络环境下运行
- 避免频繁切换网络
- 如中断可重新运行（断点续传）

### 3. 磁盘空间

预留足够磁盘空间：
- 1000只股票×5年 ≈ 250MB
- 2000只股票×5年 ≈ 500MB
- 5000只股票×5年 ≈ 1.25GB

### 4. 运行时间

批量下载需要较长时间：
- **不要**在下载过程中关闭终端
- **建议**使用`nohup`或`screen`后台运行
- **可以**使用Ctrl+C优雅中断

## 🚀 后台运行（推荐）

对于大规模下载，建议后台运行：

```bash
# 方法1: 使用nohup
nohup python scripts/batch_download_data.py \
    --market a \
    --total 1000 \
    --batch-size 50 \
    > download.log 2>&1 &

# 查看进度
tail -f download.log

# 方法2: 使用screen
screen -S download
python scripts/batch_download_data.py --market a --total 1000
# 按Ctrl+A+D分离，screen -r download重新连接
```

## 🔍 故障排除

### 问题1: API限流错误

```
抱歉，您每分钟最多访问200次
```

**解决**: 脚本会自动处理，等待60秒后继续

### 问题2: Token无效

```
ValueError: Tushare token is required
```

**解决**: 
```bash
# 在命令中指定token
python scripts/batch_download_data.py --token your_token
```

### 问题3: 美股下载失败

```
美股数据获取失败（可能需要更高权限）
```

**解决**: 美股需要Tushare高级权限，可以：
- 升级Tushare权限（充值或积分）
- 只下载A股和港股：`--market a` 或 `--market hk`

### 问题4: 下载速度慢

**原因**: API限流保护导致等待时间长

**优化方案**:
1. 减少批次大小：`--batch-size 30`（不推荐，会更慢）
2. 减少总数量：先下载部分股票测试
3. 升级Tushare权限：提高API限额

## 📚 相关文档

- [数据缓存使用指南](./数据缓存使用指南.md)
- [data/README.md](../data/README.md)
- [完整使用指南](./完整使用指南.md)

## ✅ 最佳实践

1. **首次使用**: 先用小规模测试（100只，1年）
2. **正式下载**: 使用后台运行（nohup或screen）
3. **定期更新**: 删除旧数据，重新下载最新数据
4. **备份数据**: 下载完成后备份data目录
5. **监控进度**: 使用`tail -f logs/*.log`实时查看

---

**祝下载顺利！** 如有问题请查看日志文件或提Issue。🚀
