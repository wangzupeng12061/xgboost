# 曲线横跳问题修复说明

## 问题描述

在绘制策略净值曲线时，基准指数（蓝色线）出现明显的"横跳"现象，即曲线在一段时间内保持平坦，然后突然跳到新的值，导致曲线呈现锯齿状。

## 问题原因

1. **数据频率不匹配**：
   - 基准指数数据：每个交易日都有数据（周一至周五）
   - 组合净值数据：仅在调仓日有数据（例如每20个交易日）

2. **错误的填充方法**：
   - 原代码使用 `fillna(method='ffill')` 前向填充
   - 这导致基准数据在非调仓日保持不变（形成平台）
   - 到下一个调仓日突然跳到新值（造成横跳）

```python
# 旧代码（有问题）
benchmark_values = benchmark_values.reindex(portfolio_values.index).fillna(method='ffill')
```

## 修复方案

### 方案1：只使用共同日期（不填充）

```python
# 主程序 main.py 中的修改
common_dates = portfolio_values.index.intersection(benchmark_values.index)
benchmark_values = benchmark_values[common_dates]
```

**优点**：简单直接，避免任何数据插值
**缺点**：如果调仓日和基准数据日期不完全重合，可能丢失部分数据点

### 方案2：线性插值（推荐）✅

```python
# 绘图函数中的修改
benchmark_aligned = benchmark_norm.reindex(
    portfolio_norm.index.union(benchmark_norm.index)
).interpolate(method='time').reindex(portfolio_norm.index)
```

**优点**：
- 曲线最平滑，视觉效果最好
- 使用时间加权插值，更符合金融数据特性
- 不会产生横跳现象

**缺点**：略微改变了原始数据（但仅用于可视化）

## 修复文件清单

### 1. 主程序 (main.py)
- **行 779-784**：修改基准数据加载和对齐逻辑
- 从 `fillna(method='ffill')` 改为使用交集日期

### 2. 可视化模块 (src/utils/visualization_fixed.py)
- **plot_equity_curve** (第82-120行)：使用插值对齐基准净值
- **plot_drawdown** (第135-180行)：使用插值计算回撤
- **plot_returns_distribution** (第195-240行)：使用插值计算收益率
- **create_dashboard** (第445-475行)：综合看板中的净值曲线

### 3. 可视化模块 (src/utils/visualization.py)
- **plot_equity_curve** (第74-115行)：同上
- **plot_drawdown** (第124-165行)：同上
- **plot_returns_distribution** (第180-225行)：同上
- **create_dashboard** (第446-476行)：同上

## 插值方法说明

使用的插值策略：
```python
# 1. 合并两个时间序列的所有索引
combined_index = portfolio_index.union(benchmark_index)

# 2. 重新索引并插值
benchmark_aligned = benchmark.reindex(combined_index).interpolate(method='time')

# 3. 只保留组合的日期
benchmark_aligned = benchmark_aligned.reindex(portfolio_index)
```

**`interpolate(method='time')`** 使用时间加权插值：
- 考虑日期之间的实际时间间隔
- 对于金融时间序列更准确
- 比简单线性插值更合理

## 测试验证

创建测试脚本 `test_smooth_curve.py` 验证修复效果：

```bash
python test_smooth_curve.py
```

测试将生成4个对比图：
1. `test_curve_ffill.png` - 旧方法（横跳）
2. `test_curve_common.png` - 只用共同日期
3. `test_curve_interpolate.png` - 线性插值（推荐）✅
4. `test_curve_optimized.png` - 优化后的函数

## 注意事项

1. **仅影响可视化**：插值仅用于绘图，不影响实际计算指标
2. **性能评估仍使用原始数据**：PerformanceEvaluator 使用未插值的原始数据
3. **向后兼容**：修改不影响现有功能，只是改进显示效果

## 效果对比

### 修复前
- 基准曲线呈锯齿状
- 有明显的平台期和突变
- 视觉上不连续

### 修复后
- 曲线平滑连续
- 无横跳现象
- 更符合实际市场走势

## 其他建议

如果需要更严格的数据对齐，可以考虑：

1. **使用实际交易日历**：
```python
from pandas.tseries.offsets import BDay
trading_days = pd.date_range(start, end, freq=BDay())
```

2. **记录每日净值**：
在回测过程中，即使不调仓也记录每日净值：
```python
# 在 backtester 中每日更新净值
for date in trading_dates:
    self.portfolio.update_value(date, current_prices)
```

## 总结

通过使用时间加权插值代替前向填充，成功解决了曲线横跳问题。修复后的图表更加美观、专业，更准确地反映了策略和基准的相对表现。

---
修复日期：2025-11-04
修复人员：GitHub Copilot
