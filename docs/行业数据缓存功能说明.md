# 行业数据缓存功能说明

## 概述

为了进一步提升系统性能和离线运行能力，我们为行业分类数据添加了缓存功能。行业数据现在可以像其他数据类型一样从本地缓存快速加载，无需每次都调用API。

## 功能特点

### 1. 性能提升
- **从API加载**: ~0.2秒
- **从缓存加载**: ~0.007秒
- **速度提升**: 约 **28倍**

### 2. 数据规模
- 支持 5445 只股票
- 覆盖 110 个行业分类
- 缓存文件大小: 196 KB

### 3. 完全离线
- 行业数据永久缓存（expire_days=0）
- 支持自动筛选指定股票
- 无需API调用即可使用

## 新增文件

### 1. 缓存目录
```
data/
└── industry/
    ├── industry.csv          # 行业分类数据
    └── .industry.info        # 缓存元信息
```

### 2. 下载脚本
- **文件**: `scripts/download_industry_data.py`
- **功能**: 下载并缓存行业分类数据
- **用法**: `python scripts/download_industry_data.py`

### 3. 测试脚本
- **文件**: `test/test_industry_cache.py`
- **功能**: 验证行业数据缓存加载
- **用法**: `python test/test_industry_cache.py`

## 代码修改

### 1. DataCache 类扩展
**文件**: `src/data/data_cache.py`

新增方法：
```python
# 获取行业数据
def get_industry_data(self) -> Optional[pd.DataFrame]

# 保存行业数据
def save_industry_data(self, df: pd.DataFrame)
```

### 2. DataLoader 类更新
**文件**: `src/data/data_loader.py`

修改方法：
```python
def load_industry_data(self, stock_codes: List[str] = None) -> pd.DataFrame:
    # 优先从缓存加载
    if self.use_cache and self.cache:
        cached_df = self.cache.get_industry_data()
        if cached_df is not None:
            # 筛选指定股票
            if stock_codes is not None:
                cached_df = cached_df[cached_df['stock_code'].isin(stock_codes)]
            return cached_df
    
    # 缓存未命中，从API加载并保存
    ...
```

## 使用方法

### 方式1: 下载行业数据到缓存

```bash
# 运行下载脚本
python scripts/download_industry_data.py
```

输出示例：
```
============================================================
行业分类数据下载工具
============================================================

缓存目录: ./data
过期策略: 永不过期

初始化数据加载器...
开始下载行业分类数据...

✓ 下载完成!
  记录数: 5445
  列: ts_code, name, industry, industry_code
  耗时: 0.2秒

行业分布:
  共 110 个行业
  前10个行业:
    电气设备: 340 家公司
    元器件: 301 家公司
    软件服务: 284 家公司
    ...
```

### 方式2: 在代码中使用

```python
from src.data.data_loader import DataLoader

# 初始化（启用缓存）
loader = DataLoader(
    source="tushare",
    token="your_token",
    use_cache=True,
    cache_dir="./data"
)

# 加载全部行业数据（从缓存）
industry_df = loader.load_industry_data()
# 速度: ~0.007秒

# 加载指定股票的行业数据（从缓存筛选）
test_codes = ['000001.SZ', '600000.SH', '000002.SZ']
industry_filtered = loader.load_industry_data(stock_codes=test_codes)
# 速度: ~0.004秒
```

## 数据格式

行业数据包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| ts_code | str | 股票代码（缓存格式） |
| stock_code | str | 股票代码（加载后转换） |
| name | str | 股票名称 |
| industry | str | 所属行业（申万行业分类） |
| industry_code | int | 行业编码 |

## 行业分布统计

系统支持的行业分类（前10大）：

1. **电气设备**: 340 家公司
2. **元器件**: 301 家公司
3. **软件服务**: 284 家公司
4. **专用机械**: 280 家公司
5. **化工原料**: 254 家公司
6. **汽车配件**: 252 家公司
7. **半导体**: 184 家公司
8. **医疗保健**: 176 家公司
9. **化学制药**: 149 家公司
10. **通信设备**: 136 家公司

共计 **110 个行业**分类。

## 缓存策略

### 过期策略
- **expire_days**: 0（永不过期）
- **理由**: 行业分类数据相对固定，变化频率低

### 更新策略
- 手动更新：重新运行 `download_industry_data.py`
- 自动更新：系统不会自动更新缓存（auto_update=false）

### 验证机制
- 检查缓存文件是否存在
- 读取缓存元信息
- 验证数据完整性

## 测试结果

运行测试脚本验证功能：

```bash
python test/test_industry_cache.py
```

输出：
```
============================================================
测试行业数据缓存加载
============================================================

1. 使用缓存加载:
  ✓ 加载完成
  记录数: 5445
  列: ts_code, name, industry, industry_code
  耗时: 0.007秒

2. 加载指定股票的行业数据:
  ✓ 加载完成
  记录数: 3
  耗时: 0.004秒

  示例数据:
stock_code     name  industry  industry_code
000001.SZ    平安银行        银行              0
000002.SZ     万科A     全国地产              1
600000.SH    浦发银行        银行              0

============================================================
✓ 行业数据缓存功能正常!
============================================================
```

## 系统集成

现在系统运行时会自动使用行业数据缓存：

```python
# main.py 中自动使用缓存
loader = DataLoader(
    source="tushare",
    token=config['data']['token'],
    use_cache=True,  # 启用缓存
    cache_dir="./data"
)

# 加载行业数据（自动从缓存读取）
industry_data = loader.load_industry_data()
```

## 性能对比

| 操作 | API模式 | 缓存模式 | 提升 |
|------|---------|----------|------|
| 加载全部行业数据 | 0.2秒 | 0.007秒 | **28倍** |
| 筛选特定股票 | 0.2秒+ | 0.004秒 | **50倍+** |
| API调用次数 | 1次 | 0次 | 完全离线 |

## 完整缓存列表

系统现在支持以下数据的完整缓存：

✅ **stock_daily** - 日线数据（1000只股票）
✅ **stock_basic** - 股票基本信息（5445只）
✅ **index_daily** - 指数数据（5个主要指数）
✅ **macro** - 宏观经济数据（6个指标）
✅ **financial** - 财务数据（5441只股票）
✅ **industry** - 行业分类（5445只股票，110个行业）← **新增**

## 总结

通过添加行业数据缓存：

1. ✅ **性能提升**: 加载速度提升28倍
2. ✅ **完全离线**: 所有主要数据类型都已缓存
3. ✅ **存储高效**: 仅增加196KB存储空间
4. ✅ **使用简单**: 自动从缓存加载，无需修改代码
5. ✅ **向后兼容**: API调用作为后备方案

现在系统可以完全离线运行，无需任何API调用！🎉
