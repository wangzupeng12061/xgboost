# 绩效评估模块实现说明

## 概述

绩效评估模块（`PerformanceEvaluator`）已完整实现，提供全面的量化策略评估指标。该模块集成在主程序中，能够自动计算回测结果的各项绩效指标，并支持基准对比。

## 实现状态

✅ **已完成** - 绩效评估模块完全可用

## 核心功能

### 1. 收益指标
- **累计收益率** (Total Return): 策略期间的总收益
- **年化收益率** (Annual Return): 按年化计算的收益率
- **日均收益率** (Daily Return Mean): 平均每日收益率

### 2. 风险指标
- **年化波动率** (Volatility): 收益率的标准差（年化）
- **下行波动率** (Downside Volatility): 只考虑负收益的波动率
- **最大回撤** (Max Drawdown): 从最高点到最低点的最大跌幅
- **最大回撤天数** (Max Drawdown Duration): 最长回撤持续时间
- **95% VaR** (Value at Risk): 95%置信水平的风险价值
- **95% CVaR** (Conditional VaR): 条件风险价值，超过VaR的平均损失

### 3. 风险调整收益指标
- **夏普比率** (Sharpe Ratio): (年化收益 - 无风险利率) / 年化波动率
- **索提诺比率** (Sortino Ratio): 使用下行波动率的夏普比率变种
- **卡玛比率** (Calmar Ratio): 年化收益 / 最大回撤
- **Omega比率**: 上涨收益总和 / 下跌损失总和

### 4. 相对基准指标（与沪深300对比）
- **Alpha**: 相对基准的超额收益
- **Beta**: 系统风险，组合对基准的敏感度
- **信息比率** (Information Ratio): 主动收益 / 跟踪误差
- **跟踪误差** (Tracking Error): 组合与基准收益率差的标准差
- **主动收益** (Active Return): 组合收益 - 基准收益（年化）
- **上行捕获率** (Up Capture): 基准上涨时组合的跟随能力
- **下行捕获率** (Down Capture): 基准下跌时组合的抵抗能力

### 5. 交易统计
- **胜率** (Win Rate): 盈利交易日占比
- **盈亏比** (Profit/Loss Ratio): 平均盈利 / 平均亏损

## 实际运行结果示例

```
================================================================================
绩效评估报告
================================================================================

📊 收益指标
--------------------------------------------------------------------------------
  累计收益率:             -8.14%
  年化收益率:            -14.27%
  日均收益率:           -0.0549%

📉 风险指标
--------------------------------------------------------------------------------
  年化波动率:             18.33%
  下行波动率:             12.98%
  最大回撤:              -16.42%
  最大回撤天数:             125 天
  95% VaR:               -1.60%
  95% CVaR:              -2.77%

⚖️  风险调整收益
--------------------------------------------------------------------------------
  夏普比率:             -0.9423
  索提诺比率:           -1.3308
  卡玛比率:             -0.8695
  Omega比率:            0.8800

📈 相对基准指标
--------------------------------------------------------------------------------
  Alpha:                -21.55%
  Beta:                 0.8592
  信息比率:             -1.5222
  跟踪误差:               14.71%
  主动收益:              -22.26%
  上行捕获率:             75.02%
  下行捕获率:            106.16%

🎯 交易统计
--------------------------------------------------------------------------------
  胜率:                   42.03%
  盈亏比:                1.1834

================================================================================
```

## 技术实现

### 模块位置
- 文件路径: `src/backtest/evaluator.py`
- 主程序集成: `main.py` 第9步

### 核心类: PerformanceEvaluator

```python
from src.backtest.evaluator import PerformanceEvaluator

# 初始化评估器
evaluator = PerformanceEvaluator(
    portfolio_values=portfolio_values,  # 组合净值序列（pd.Series，index为日期）
    benchmark_values=benchmark_values,  # 基准净值序列（可选）
    risk_free_rate=0.03                 # 无风险利率（年化）
)

# 计算所有指标
metrics = evaluator.calculate_all_metrics()

# 生成可读报告
report = evaluator.generate_report()
print(report)
```

### 数据要求

1. **组合净值序列** (`portfolio_values`)
   - 类型: `pd.Series`
   - 索引: 日期（`pd.DatetimeIndex`）
   - 值: 组合净值（通常以初始资金为起点）

2. **基准净值序列** (`benchmark_values`, 可选)
   - 类型: `pd.Series`
   - 索引: 日期（需与组合净值日期对齐）
   - 值: 基准净值（归一化到与组合相同的起始值）

### 自动化流程

在主程序中，绩效评估模块自动完成以下步骤：

1. **获取回测数据**: 从 `Backtester` 提取组合净值数据
2. **加载基准数据**: 从 Tushare 加载沪深300指数数据（配置中指定）
3. **对齐数据**: 将基准数据与组合数据的日期对齐
4. **计算指标**: 计算22项绩效指标
5. **生成报告**: 生成格式化的文本报告
6. **保存结果**: 
   - CSV文件: `performance_metrics_{timestamp}.csv` - 所有指标的数值
   - TXT文件: `performance_report_{timestamp}.txt` - 格式化报告

## 配置参数

在 `config/config.yaml` 中相关配置：

```yaml
backtest:
  benchmark: "000300.SH"        # 基准指数代码（沪深300）
  risk_free_rate: 0.03          # 无风险利率（年化，3%）
  
output:
  report_path: "results/reports/"  # 报告保存路径
```

## 输出文件

### 1. 性能指标CSV (`performance_metrics_{timestamp}.csv`)
包含所有22项指标的数值数据，便于后续分析和对比。

字段列表：
- total_return, annual_return, daily_return_mean
- volatility, downside_volatility, max_drawdown, max_drawdown_duration
- sharpe_ratio, sortino_ratio, calmar_ratio, omega_ratio
- alpha, beta, information_ratio, tracking_error, active_return
- up_capture, down_capture
- win_rate, profit_loss_ratio
- var_95, cvar_95

### 2. 性能报告TXT (`performance_report_{timestamp}.txt`)
格式化的文本报告，包含所有指标的可读展示，适合直接查看和分享。

## 使用示例

### 基本使用
```python
# 在主程序中自动执行
python main.py
```

### 手动使用
```python
import pandas as pd
from src.backtest.evaluator import PerformanceEvaluator

# 准备数据
portfolio_values = pd.Series([...], index=pd.date_range(...))
benchmark_values = pd.Series([...], index=pd.date_range(...))

# 评估
evaluator = PerformanceEvaluator(
    portfolio_values=portfolio_values,
    benchmark_values=benchmark_values,
    risk_free_rate=0.03
)

# 查看报告
print(evaluator.generate_report())

# 获取具体指标
metrics = evaluator.calculate_all_metrics()
print(f"夏普比率: {metrics['sharpe_ratio']:.4f}")
print(f"最大回撤: {metrics['max_drawdown']:.2f}%")
```

## 指标解读

### 优秀策略的参考标准

| 指标 | 优秀水平 | 良好水平 | 说明 |
|------|---------|---------|------|
| 夏普比率 | > 2.0 | > 1.0 | 风险调整后收益，越高越好 |
| 最大回撤 | < -10% | < -20% | 最大损失幅度，绝对值越小越好 |
| 年化收益率 | > 20% | > 10% | 长期收益能力 |
| 胜率 | > 55% | > 50% | 盈利交易占比 |
| 信息比率 | > 1.0 | > 0.5 | 主动管理能力，越高越好 |
| 卡玛比率 | > 1.0 | > 0.5 | 收益与回撤的平衡 |

### 当前策略分析

基于实际运行结果：
- ❌ **收益表现**: -8.14%累计收益，需要优化
- ⚠️ **风险控制**: 18.33%年化波动率，-16.42%最大回撤，风险较高
- ❌ **风险调整收益**: 负夏普比率（-0.94），风险调整后表现不佳
- ⚠️ **相对基准**: Beta=0.86，下行捕获率106%，下跌时跌得比基准多
- ⚠️ **交易质量**: 42%胜率，盈亏比1.18，略显不足

## 优化建议

1. **提高因子质量**
   - 重新筛选IC/ICIR更高的因子
   - 考虑因子组合和交互项
   - 增加防守型因子（如低波动、质量因子）

2. **优化模型参数**
   - 调整XGBoost超参数
   - 尝试不同的标签构建方法
   - 增加样本权重考虑

3. **改进选股策略**
   - 调整持仓数量（当前50只）
   - 引入行业中性约束
   - 增加止损/止盈机制

4. **风险管理**
   - 设置最大回撤阈值
   - 增加波动率调整
   - 考虑市场环境适应性

## 扩展功能（未来可实现）

1. **滚动绩效分析**: 计算不同时间窗口的绩效稳定性
2. **分段分析**: 按牛市/熊市/震荡市分别评估
3. **归因分析**: 收益归因到因子、行业、个股
4. **蒙特卡洛模拟**: 评估策略的稳健性
5. **压力测试**: 极端市场情况下的表现

## 总结

✅ 绩效评估模块已完整实现并集成到主程序中  
✅ 支持22项全面的量化指标  
✅ 自动生成可读报告和数据文件  
✅ 支持基准对比（沪深300）  
✅ 可用于策略评估和优化指导  

下一步可以：
- 实现可视化图表（净值曲线、回撤图等）
- 进行策略优化以改善当前负收益状况
- 增加更多风险管理功能
