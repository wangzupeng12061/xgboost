# XGBoostå¤šå› å­é€‰è‚¡ - å®Œæ•´ä½¿ç”¨æŒ‡å—

## ğŸ“¦ å·²å®Œæˆçš„æ‰€æœ‰æ–‡ä»¶

### âœ… é…ç½®æ–‡ä»¶ (3ä¸ª)
1. **step1_requirements.txt** - Pythonä¾èµ–åŒ…
2. **step1_config.yaml** - ä¸»é…ç½®æ–‡ä»¶
3. **step1_factor_config.json** - å› å­é…ç½®

### âœ… æ•°æ®æ¨¡å— (2ä¸ª)
4. **step2_data_loader.py** - æ•°æ®åŠ è½½ï¼ˆTushare/AKShareï¼‰
5. **step2_data_processor.py** - æ•°æ®å¤„ç†å’Œæ¸…æ´—

### âœ… å› å­æ¨¡å— (4ä¸ª)
6. **step3_factor_calculator_part1.py** - å› å­è®¡ç®—ï¼ˆä¼°å€¼ã€æˆé•¿ã€ç›ˆåˆ©ã€è´¨é‡ã€åŠ¨é‡ã€æ³¢åŠ¨ï¼‰
7. **step3_factor_calculator_part2.py** - å› å­è®¡ç®—ï¼ˆæµåŠ¨æ€§ã€æŠ€æœ¯æŒ‡æ ‡ï¼‰
8. **step4_factor_processor.py** - å› å­é¢„å¤„ç†ï¼ˆå»æå€¼ã€æ ‡å‡†åŒ–ã€ä¸­æ€§åŒ–ï¼‰
9. **step4_factor_selector.py** - å› å­ç­›é€‰ï¼ˆICåˆ†æï¼‰

### âœ… æ¨¡å‹æ¨¡å— (2ä¸ª)
10. **step5_label_builder.py** - æ ‡ç­¾æ„å»º
11. **step5_xgb_model.py** - XGBoostæ¨¡å‹è®­ç»ƒå’Œé¢„æµ‹

### âœ… ç­–ç•¥æ¨¡å— (1ä¸ª)
12. **step6_stock_selector.py** - é€‰è‚¡ç­–ç•¥

### âœ… ä¸»ç¨‹åº (1ä¸ª)
13. **step7_main_simplified.py** - ç®€åŒ–ç‰ˆä¸»ç¨‹åºï¼ˆå«æ¼”ç¤ºæ¨¡å¼ï¼‰

### ğŸ“„ æ–‡æ¡£ (3ä¸ª)
14. **XGBoostå¤šå› å­é€‰è‚¡é¡¹ç›®æ–‡æ¡£.md** - å®Œæ•´é¡¹ç›®æ–‡æ¡£
15. **README_è¿›åº¦è¯´æ˜.md** - è¿›åº¦è¯´æ˜
16. **è¿›åº¦æ›´æ–°_Step5å®Œæˆ.md** - Step5å®Œæˆçš„æ›´æ–°

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
# å®‰è£…PythonåŒ…
pip install -r step1_requirements.txt

# æˆ–è€…ä½¿ç”¨conda
conda create -n xgboost_stock python=3.8
conda activate xgboost_stock
pip install -r step1_requirements.txt
```

### ç¬¬äºŒæ­¥ï¼šé…ç½®

ç¼–è¾‘ `step1_config.yaml`ï¼Œå¡«å…¥ä½ çš„Tushare tokenï¼š

```yaml
data:
  source: "tushare"
  token: "YOUR_TUSHARE_TOKEN_HERE"  # åœ¨ https://tushare.pro æ³¨å†Œè·å–
  start_date: "2020-01-01"
  end_date: "2024-12-31"
```

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œæ¼”ç¤º

```bash
# è¿è¡Œå¿«é€Ÿæ¼”ç¤ºï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œæ— éœ€tokenï¼‰
python step7_main_simplified.py --demo
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
================================================================================
å¿«é€Ÿæ¼”ç¤ºæ¨¡å¼ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
================================================================================

åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®...
âœ“ åˆ›å»ºäº† 20000 æ¡æ•°æ®

æ„å»ºæ ‡ç­¾...
âœ“ æœ‰æ•ˆæ ·æœ¬: 16000

è®­ç»ƒæ¨¡å‹...
  è®­ç»ƒXGBoostæ¨¡å‹...
âœ“ è®­ç»ƒé›†å‡†ç¡®ç‡: 0.8765
âœ“ æµ‹è¯•é›†å‡†ç¡®ç‡: 0.5234

é€‰è‚¡...
âœ“ é€‰å‡º 20 åªè‚¡ç¥¨

é€‰ä¸­çš„è‚¡ç¥¨:
stock_code     score
    000042  0.987654
    000123  0.976543
    ...
```

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨æµç¨‹

### æµç¨‹1ï¼šæ•°æ®åŠ è½½

```python
from step2_data_loader import DataLoader

# åˆå§‹åŒ–åŠ è½½å™¨
loader = DataLoader(source='tushare', token='YOUR_TOKEN')

# åŠ è½½è‚¡ç¥¨åˆ—è¡¨
stock_list = loader.load_stock_list()

# åŠ è½½æ—¥çº¿æ•°æ®
price_data = loader.load_daily_data(
    start_date='2020-01-01',
    end_date='2024-12-31'
)

# åŠ è½½è´¢åŠ¡æ•°æ®
financial_data = loader.load_financial_data(
    start_date='2020-01-01',
    end_date='2024-12-31'
)

# åŠ è½½æŒ‡æ•°æ•°æ®ï¼ˆç”¨ä½œåŸºå‡†ï¼‰
index_data = loader.load_index_data(
    index_code='000300.SH',  # æ²ªæ·±300
    start_date='2020-01-01',
    end_date='2024-12-31'
)
```

### æµç¨‹2ï¼šæ•°æ®å¤„ç†

```python
from step2_data_processor import DataProcessor

processor = DataProcessor()

# æ¸…æ´—æ•°æ®
cleaned_data = processor.clean_data(
    price_data,
    drop_st=True,              # å‰”é™¤STè‚¡ç¥¨
    drop_suspended=True,        # å‰”é™¤åœç‰Œ
    min_liquidity=1000000      # æœ€å°æµåŠ¨æ€§
)

# åˆå¹¶æ•°æ®
full_data = processor.merge_data(
    price_data=cleaned_data,
    financial_data=financial_data
)

# å¤„ç†ç¼ºå¤±å€¼
processed_data = processor.handle_missing_values(
    full_data,
    columns=['close', 'volume'],
    method='forward_fill'
)
```

### æµç¨‹3ï¼šå› å­è®¡ç®—

```python
from step3_factor_calculator_part1 import FactorCalculator
from step3_factor_calculator_part2 import FactorCalculatorExtended

# åŸºç¡€å› å­
calc = FactorCalculator(processed_data)
factor_data = calc.calculate_valuation_factors()
factor_data = calc.calculate_growth_factors()
factor_data = calc.calculate_profitability_factors()
factor_data = calc.calculate_quality_factors()
factor_data = calc.calculate_momentum_factors()
factor_data = calc.calculate_volatility_factors()

# æµåŠ¨æ€§å’ŒæŠ€æœ¯å› å­
calc_ext = FactorCalculatorExtended(factor_data)
factor_data = calc_ext.calculate_liquidity_factors()
factor_data = calc_ext.calculate_technical_factors()

print(f"è®¡ç®—äº† {len(factor_data.columns)} ä¸ªå› å­")
```

### æµç¨‹4ï¼šå› å­é¢„å¤„ç†

```python
from step4_factor_processor import FactorProcessor

# å®šä¹‰å› å­åˆ—è¡¨
factor_columns = ['PE', 'PB', 'ROE', 'ROA', 'revenue_growth', 
                 'return_20d', 'volatility_20d', 'turnover_rate']

# é¢„å¤„ç†
processor = FactorProcessor(factor_data, factor_columns)

processed_factor_data = processor.process_pipeline(
    winsorize_method='mad',        # å»æå€¼
    standardize_method='zscore',    # æ ‡å‡†åŒ–
    neutralize=True,                # ä¸­æ€§åŒ–
    fill_method='industry_median'   # å¡«å……ç¼ºå¤±å€¼
)

# æŸ¥çœ‹ç»Ÿè®¡
stats = processor.get_factor_stats()
print(stats)
```

### æµç¨‹5ï¼šå› å­ç­›é€‰

```python
from step4_factor_selector import FactorSelector
from step5_label_builder import LabelBuilder

# æ„å»ºæ ‡ç­¾
builder = LabelBuilder(processed_factor_data)
labeled_data = builder.create_return_label(
    forward_days=20,
    label_type='classification',
    threshold=0.0
)

# å› å­ç­›é€‰
selector = FactorSelector(
    labeled_data, 
    factor_columns,
    forward_return_col='forward_return'
)

# è®¡ç®—IC
ic_df = selector.calculate_ic(method='spearman')

# è¯„ä¼°å› å­
evaluation = selector.evaluate_factors(ic_df)
print(evaluation.head(20))

# ç­›é€‰ä¼˜è´¨å› å­
selected_factors = selector.select_by_ic(
    ic_threshold=0.03,
    icir_threshold=0.5
)

# å»é™¤é«˜ç›¸å…³å› å­
final_factors = selector.remove_correlated_factors(
    correlation_threshold=0.7,
    factors=selected_factors
)

print(f"æœ€ç»ˆé€‰æ‹© {len(final_factors)} ä¸ªå› å­: {final_factors}")
```

### æµç¨‹6ï¼šæ¨¡å‹è®­ç»ƒ

```python
from step5_xgb_model import XGBoostModel
from sklearn.model_selection import train_test_split

# å‡†å¤‡æ•°æ®
X = labeled_data[final_factors]
y = labeled_data['label']

# æŒ‰æ—¶é—´åˆ†å‰²ï¼ˆé¿å…æœªæ¥æ•°æ®æ³„éœ²ï¼‰
split_date = '2023-01-01'
train_data = labeled_data[labeled_data['date'] < split_date]
test_data = labeled_data[labeled_data['date'] >= split_date]

X_train = train_data[final_factors]
y_train = train_data['label']
X_test = test_data[final_factors]
y_test = test_data['label']

# åˆ’åˆ†éªŒè¯é›†
X_train, X_val, y_train, y_val = train_test_split(
    X_train, y_train, test_size=0.2, random_state=42
)

# è®­ç»ƒæ¨¡å‹
model = XGBoostModel(
    task_type='classification',
    params={
        'max_depth': 5,
        'learning_rate': 0.1,
        'n_estimators': 100,
        'subsample': 0.8,
        'colsample_bytree': 0.8
    }
)

model.train(
    X_train, y_train,
    X_val, y_val,
    early_stopping_rounds=10,
    verbose=True
)

# è¯„ä¼°
test_metrics = model.evaluate(X_test, y_test)
print(f"\næµ‹è¯•é›†è¯„ä¼°:")
for metric, value in test_metrics.items():
    print(f"  {metric}: {value:.4f}")

# ç‰¹å¾é‡è¦æ€§
importance = model.get_feature_importance(top_n=10)
print(f"\nTop 10 é‡è¦å› å­:")
print(importance)

# ä¿å­˜æ¨¡å‹
model.save_model('models/xgb_model_20241103.pkl')
```

### æµç¨‹7ï¼šé€‰è‚¡

```python
from step6_stock_selector import StockSelector

# åˆ›å»ºé€‰è‚¡å™¨
selector = StockSelector(
    model=model,
    n_stocks=50,
    method='top_n'  # 'top_n', 'threshold', 'portfolio'
)

# è·å–æœ€æ–°æ•°æ®
latest_date = labeled_data['date'].max()
latest_data = labeled_data[labeled_data['date'] == latest_date]

X_latest = latest_data[final_factors]
stock_codes = latest_data['stock_code'].tolist()

# é€‰è‚¡
selected_stocks = selector.select_stocks(
    X_latest,
    latest_date,
    stock_codes
)

print(f"\né€‰ä¸­ {len(selected_stocks)} åªè‚¡ç¥¨:")
print(selected_stocks[['stock_code', 'score', 'weight']].head(20))

# ä¿å­˜ç»“æœ
selected_stocks.to_csv(
    f'results/selected_stocks_{latest_date}.csv',
    index=False
)

# è·å–é€‰è‚¡æ‘˜è¦
summary = selector.get_selection_summary(selected_stocks)
print(f"\né€‰è‚¡æ‘˜è¦:")
for key, value in summary.items():
    print(f"  {key}: {value}")
```

---

## ğŸ¨ è¿›é˜¶ç”¨æ³•

### 1. ç»„åˆä¼˜åŒ–é€‰è‚¡

```python
# ä½¿ç”¨ç»„åˆä¼˜åŒ–æ–¹æ³•ï¼Œè€ƒè™‘è¡Œä¸šåˆ†æ•£
selector = StockSelector(
    model=model,
    n_stocks=50,
    method='portfolio'
)

selected_stocks = selector.select_stocks(
    X_latest,
    latest_date,
    stock_codes,
    max_industry_weight=0.3,      # å•è¡Œä¸šæœ€å¤§30%
    weight_method='score_weighted' # åŸºäºå¾—åˆ†åŠ æƒ
)
```

### 2. å¤šç©ºç­–ç•¥

```python
# å¤šç©ºé€‰è‚¡
long_short = selector.select_long_short(
    X_latest,
    latest_date,
    stock_codes,
    long_ratio=0.1,   # åšå¤šå‰10%
    short_ratio=0.1   # åšç©ºå10%
)

print(f"åšå¤š: {len(long_short['long'])} åª")
print(f"åšç©º: {len(long_short['short'])} åª")
```

### 3. è¶…é¢æ”¶ç›Šæ ‡ç­¾

```python
# æ„å»ºè¶…é¢æ”¶ç›Šæ ‡ç­¾
labeled_data = builder.create_excess_return_label(
    forward_days=20,
    benchmark_col='index_return',
    label_type='classification'
)
```

### 4. æ ·æœ¬æƒé‡

```python
# æ·»åŠ æ—¶é—´è¡°å‡æƒé‡
weighted_data = builder.add_sample_weights(
    labeled_data,
    method='time_decay',
    half_life=60
)

# è®­ç»ƒæ—¶ä½¿ç”¨æƒé‡
model.train(
    X_train, y_train,
    X_val, y_val,
    sample_weight=weighted_data['sample_weight']
)
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è·å–Tushare token?

1. è®¿é—® https://tushare.pro
2. æ³¨å†Œè´¦å·
3. åœ¨ä¸ªäººä¸­å¿ƒè·å–token
4. å¡«å…¥ `step1_config.yaml`

### Q2: æ²¡æœ‰Tushare tokenæ€ä¹ˆåŠ?

ä½¿ç”¨AKShareï¼ˆå…è´¹ï¼‰:
```python
loader = DataLoader(source='akshare')
```

æˆ–è¿è¡Œæ¼”ç¤ºæ¨¡å¼ï¼š
```bash
python step7_main_simplified.py --demo
```

### Q3: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å› å­?

åœ¨å› å­è®¡ç®—æ¨¡å—ä¸­æ·»åŠ ï¼š
```python
def calculate_my_factor(self):
    df = self.data.copy()
    df['my_factor'] = df['close'] / df['volume']
    return df
```

### Q4: æ¨¡å‹è¿‡æ‹Ÿåˆæ€ä¹ˆåŠ?

- å¢åŠ æ­£åˆ™åŒ–å‚æ•°ï¼ˆreg_alpha, reg_lambdaï¼‰
- ä½¿ç”¨early_stopping
- å‡å°‘max_depth
- å¢åŠ æ ·æœ¬æ•°é‡

### Q5: ICä¸ç¨³å®šæ€ä¹ˆåŠ?

- æ£€æŸ¥å› å­é¢„å¤„ç†æ˜¯å¦æ­£ç¡®
- å°è¯•ä¸åŒçš„æ ‡å‡†åŒ–æ–¹æ³•
- å¢åŠ æ ·æœ¬é‡
- ä½¿ç”¨æ›´ç¨³å®šçš„å› å­

---

## ğŸ“Š é¡¹ç›®ç»“æ„

```
xgboost_stock_selection/
â”œâ”€â”€ step1_requirements.txt           # ä¾èµ–
â”œâ”€â”€ step1_config.yaml                # é…ç½®
â”œâ”€â”€ step1_factor_config.json         # å› å­é…ç½®
â”œâ”€â”€ step2_data_loader.py             # æ•°æ®åŠ è½½
â”œâ”€â”€ step2_data_processor.py          # æ•°æ®å¤„ç†
â”œâ”€â”€ step3_factor_calculator_part1.py # å› å­è®¡ç®—1
â”œâ”€â”€ step3_factor_calculator_part2.py # å› å­è®¡ç®—2
â”œâ”€â”€ step4_factor_processor.py        # å› å­é¢„å¤„ç†
â”œâ”€â”€ step4_factor_selector.py         # å› å­ç­›é€‰
â”œâ”€â”€ step5_label_builder.py           # æ ‡ç­¾æ„å»º
â”œâ”€â”€ step5_xgb_model.py               # æ¨¡å‹è®­ç»ƒ
â”œâ”€â”€ step6_stock_selector.py          # é€‰è‚¡ç­–ç•¥
â”œâ”€â”€ step7_main_simplified.py         # ä¸»ç¨‹åº
â”œâ”€â”€ models/                          # ä¿å­˜çš„æ¨¡å‹
â”œâ”€â”€ results/                         # ç»“æœè¾“å‡º
â””â”€â”€ docs/                            # æ–‡æ¡£
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æ•°æ®è´¨é‡ç¬¬ä¸€**: ç¡®ä¿æ•°æ®å‡†ç¡®ã€å®Œæ•´
2. **å› å­é¢„å¤„ç†**: å¿…é¡»è¿›è¡Œå»æå€¼å’Œæ ‡å‡†åŒ–
3. **é¿å…è¿‡æ‹Ÿåˆ**: ä½¿ç”¨æ—¶é—´åºåˆ—éªŒè¯ï¼Œä¸ç”¨éšæœºåˆ’åˆ†
4. **å®šæœŸå†è®­ç»ƒ**: å¸‚åœºå˜åŒ–æ—¶æ›´æ–°æ¨¡å‹
5. **é£é™©æ§åˆ¶**: è®¾ç½®æ­¢æŸã€åˆ†æ•£æŠ•èµ„
6. **å›æµ‹éªŒè¯**: å……åˆ†å›æµ‹åå†å®ç›˜
7. **äº¤æ˜“æˆæœ¬**: è€ƒè™‘ä½£é‡‘å’Œæ»‘ç‚¹

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å®Œæ•´å›æµ‹**: å®ç°å®Œæ•´çš„å›æµ‹ç³»ç»Ÿ
2. **ç»©æ•ˆè¯„ä¼°**: æ·»åŠ å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ç­‰æŒ‡æ ‡
3. **å¯è§†åŒ–**: ç»˜åˆ¶å‡€å€¼æ›²çº¿ã€å› å­åˆ†æå›¾è¡¨
4. **å®ç›˜æ¥å£**: å¯¹æ¥åˆ¸å•†API
5. **ç›‘æ§ç³»ç»Ÿ**: å®æ—¶ç›‘æ§æŒä»“å’Œé£é™©

---

## ğŸ“ è·å–å¸®åŠ©

- æŸ¥çœ‹å®Œæ•´æ–‡æ¡£: `XGBoostå¤šå› å­é€‰è‚¡é¡¹ç›®æ–‡æ¡£.md`
- æŸ¥çœ‹è¿›åº¦è¯´æ˜: `README_è¿›åº¦è¯´æ˜.md`
- æ¯ä¸ªæ¨¡å—éƒ½æœ‰æµ‹è¯•ä»£ç å¯ä»¥å‚è€ƒ

---

**ç¥æ‚¨ä½¿ç”¨é¡ºåˆ©ï¼é‡åŒ–æŠ•èµ„ï¼Œç†æ€§å†³ç­–ï¼** ğŸ“ˆ
